<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vocabulary Manager - WordWhizzy</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    
    <style>
    /* --- BẢNG MÀU XANH DƯƠNG MỚI --- */
      :root {
        --bg: #ffffff;
        --bg-soft: #F0F7FF; /* Light Blue */
        --text: #1A2B4D; /* Dark Navy Blue */
        --text-muted: #6B7A90; /* Slate Blue */
        --border: #DDE5EE; /* Light Blue-Gray */
        --radius: 14px;
        --shadow: 0 8px 24px rgba(59, 130, 246, 0.1); /* Blueish Shadow */
        --accent: #3B82F6; /* Primary Blue */
        --success: #28a745;
        --error: #dc3545;
        --warning: #ffc107;
        font-synthesis: none;
      }

      /* --- Base & Reset --- */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html, body {
        height: 100%;
        background: var(--bg);
        color: var(--text);
        font-family: "Inter", sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      a { text-decoration: none; color: inherit; }
      
      /* --- Header from trangchu.txt --- */
      header.app-header{
        position:fixed;left:0;right:0;top:0;height:72px;
        display:flex;align-items:center;justify-content:space-between;
        padding:0 24px;
        background:rgba(255,255,255,0.8);
        border-bottom:1px solid var(--border);
        z-index:1200;
        backdrop-filter: blur(8px);
      }
      .brand{display:flex;align-items:center;gap:12px;}
      .logo {
        width: auto; /* Tự động điều chỉnh chiều rộng */
        max-height: 48px; /* Giữ chiều cao tối đa của logo */
        border-radius: 8px; /* Giữ bo góc để hợp với thiết kế chung */
        object-fit: contain; /* Đảm bảo toàn bộ logo được hiển thị, không bị cắt xén */
        transition: max-height 0.3s ease; /* Thêm hiệu ứng chuyển động mượt mà */
      }
      .site-title{font-weight:600;font-size:18px;}
      .main-nav{display:flex;align-items:center;gap:4px;margin-left:16px}
      .main-nav a{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;color:var(--text-muted);font-weight:500;font-size:14px;
      transition: all 0.2s ease;}
      .main-nav a:hover, .main-nav a.active{background:var(--bg-soft);color:var(--text)}
      .main-nav a.active i {color: var(--accent);} /* Make active icon blue */

      .header-right{display:flex;align-items:center;gap:12px}
      .icon-btn{width:44px;height:44px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center;color:var(--text-muted);border:1px solid transparent;cursor:pointer;
      transition: all 0.2s ease; position: relative;}
      .icon-btn:hover{background:var(--bg-soft);color:var(--text);border-color:var(--border)}
      a.icon-btn{color:var(--text-muted);}
      a.icon-btn:hover{color:var(--accent);} /* Make icon blue on hover */
      
      .user-display{display:flex;align-items:center;gap:10px;cursor:pointer}
      .user-display img{width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid var(--border)}
      
      /* NEW: Dropdown Menu styles */
      .mobile-menu-dropdown {
        display: none;
        position: absolute;
        right: 0;
        top: 60px;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 8px;
        box-shadow: var(--shadow);
        z-index: 1300;
        width: 200px;
      }
      .mobile-menu-dropdown a {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        border-radius: 8px;
        color: var(--text-muted);
        font-size: 14px;
        font-weight: 500;
      }
      .mobile-menu-dropdown a:hover {
        background-color: var(--bg-soft);
        color: var(--text);
      }
      .mobile-menu-btn { display: none; } /* Hide by default */

      /* --- Vocabulary Page Layout --- */
      .app-container {
        display: flex;
        height: 100vh;
        padding-top: 72px; /* For fixed header */
      }

      .sidebar {
        width: 280px;
        background: var(--bg);
        border-right: 1px solid var(--border);
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
        height: 100%;
        transition: transform 0.3s ease;
        z-index: 1000;
      }
      
      .sidebar.active {
        transform: translateX(0) !important;
        box-shadow: 0 0 40px rgba(0,0,0,0.1);
      }

      .days-nav {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        overflow-y: auto;
      }

      .day-item {
        padding: 0.75rem 1rem;
        border-radius: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-weight: 500;
        color: var(--text-muted);
        border: 1px solid transparent;
        transition: all 0.3s ease;
      }

      .day-item:hover {
        background: var(--bg-soft);
        color: var(--text);
      }

      .day-item.active {
        background: var(--bg-soft);
        color: var(--text);
        font-weight: 600;
        border: 1px solid var(--border);
      }

      .day-item i { width: 18px; text-align: center; }
      .day-item:hover i, .day-item.active i { color: inherit; }
      
      .day-item .count {
        margin-left: auto;
        background: var(--border);
        color: var(--text-muted);
        padding: 0.2rem 0.6rem;
        border-radius: 999px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .day-item.active .count {
        background: var(--accent);
        color: var(--bg);
      }

      .main-content {
        flex-grow: 1;
        padding: 2rem;
        overflow-y: auto;
      }
      
      /* --- General UI Elements --- */
      .btn{
        display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 20px;border-radius:12px;font-weight:600;font-size:15px;border:1px solid var(--border);cursor:pointer;
        transition: all 0.2s ease;
      }
      .btn-primary{background:var(--accent);color:#fff;border-color:var(--accent)}
      .btn-primary:hover{transform: translateY(-2px); box-shadow: var(--shadow);}
      .btn-secondary{background:var(--bg);color:var(--text)}
      .btn-secondary:hover{background: var(--bg-soft); border-color: #ddd; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05);}
      
      .header-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .content-header h2 {
        font-size: 2rem;
        font-weight: 700;
        letter-spacing: -0.5px;
        color: var(--text);
      }

      .create-form {
        background: var(--bg-soft);
        padding: 1.5rem;
        border-radius: var(--radius);
        margin-bottom: 2rem;
        border: 1px solid var(--border);
      }

      .form-group { margin-bottom: 1rem; }
      .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 14px; }
      .form-group input, .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: 10px;
        font-size: 15px;
        background: var(--bg);
        transition: all 0.3s ease;
      }
      .form-group textarea { min-height: 100px; resize: vertical; }
      .form-group input:focus, .form-group textarea:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      
      .folder-grid, .large-folder-grid, .subfolder-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
      }

      .folder-card, .large-folder-card, .subfolder-card {
        background: var(--bg);
        border-radius: var(--radius);
        padding: 1.5rem;
        border: 1px solid var(--border);
        box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
      }
      
      .folder-card:hover, .large-folder-card:hover, .subfolder-card:hover { 
        transform: translateY(-4px);
        box-shadow: var(--shadow);
        border-color: var(--accent);
      }
      .folder-header, .large-folder-header, .subfolder-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
      .folder-title, .large-folder-title, .subfolder-title { font-size: 1.125rem; font-weight: 600; }
      .folder-day { background: var(--bg-soft); color: var(--text-muted); padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.8rem; font-weight: 500; }
      .folder-description, .subfolder-description { color: var(--text-muted); font-size: 0.9rem; line-height: 1.5; margin-bottom: 1rem; flex-grow: 1; }
      .folder-stats, .subfolder-stats { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1.25rem; }
      .stats-item { display: flex; justify-content: space-between; font-size: 0.875rem; }
      .stats-item i { color: var(--text-muted); margin-right: 0.5rem; }
      .folder-actions, .large-folder-actions, .subfolder-actions { display: flex; flex-wrap: wrap; margin-top: auto; padding-top: 1rem; border-top: 1px solid var(--border); gap: 0.5rem; }
      .folder-actions .btn, .large-folder-actions .btn, .subfolder-actions .btn { flex-grow: 1; padding: 8px 12px; font-size: 14px; }
      
      .progress-container { margin-top: 1rem; background: var(--border); border-radius: 999px; height: 6px; overflow: hidden; }
      .progress-bar { height: 100%; background: var(--accent); border-radius: 999px; transition: width 0.3s ease; }
      
      .empty-state { text-align: center; padding: 3rem; background: var(--bg-soft); border-radius: var(--radius); border: 2px dashed var(--border); color: var(--text-muted); }
      .empty-state h3 { font-size: 1.2rem; color: var(--text); margin-bottom: 0.5rem; }

      .modal { display: flex; position: fixed; z-index: 1300; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(10, 10, 10, 0.4); overflow: auto; align-items: center; justify-content: center; }
      .modal-content { background: var(--bg); padding: 1.5rem 2rem; border-radius: var(--radius); box-shadow: var(--shadow); width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; position: relative; border: 1px solid var(--border); }
      .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
      .modal-title { font-size: 1.25rem; font-weight: 600; }
      .close { color: var(--text-muted); font-size: 1.5rem; cursor: pointer; transition: all 0.3s ease; }
      .close:hover { color: var(--accent); }
      
      .word-list { max-height: 250px; overflow-y: auto; margin-bottom: 1rem; }
      .word-item { display: flex; justify-content: space-between; padding: 0.75rem; border-bottom: 1px solid var(--border); }
      .word-item:last-child { border-bottom: none; }
      .word-item:hover { background: var(--bg-soft); }
      .word-term { font-weight: 500; }
      .word-definition { color: var(--text-muted); text-align: right; max-width: 60%; }
      
      .folder-list-container { max-height: 300px; overflow-y: auto; padding: 0.5rem; border: 1px solid var(--border); border-radius: 10px; margin-bottom: 1rem; background: var(--bg-soft); }
      .folder-checkbox { margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem; border-radius: 8px; }
      .folder-checkbox:hover { background: var(--bg); }
      .folder-checkbox input { width: 16px; height: 16px; accent-color: var(--accent); }
      .folder-checkbox label { font-weight: 500; }

      .notification { position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; font-size: 15px; font-weight: 500; border-radius: 10px; color: #fff; box-shadow: var(--shadow); z-index: 2000; transform: translateY(120px); opacity: 0; transition: all 0.4s cubic-bezier(0.215, 0.610, 0.355, 1); }
      .notification.show { transform: translateY(0); opacity: 1; }
      .muted{color:var(--text-muted);font-size:13px}
      .tiny{font-size:12px;color:var(--text-muted-2)}
      
      /* --- Responsive --- */
      .sidebar-toggle-header { display: none; }
      .sidebar-toggle-mobile { display: none; }

      @media (max-width: 900px) {
        .folder-grid, .large-folder-grid, .subfolder-grid { grid-template-columns:1fr; }
        .content-header h2 { font-size: 1.75rem; }
      }

      @media (max-width: 820px){
        /* Hide original nav links */
        .main-nav a[href="../chatai.html"],
        .main-nav a[href="../roomchat.html"],
        .main-nav a[href="#pricing"] {
          display: none;
        }
        .main-nav span { display: none; }
        .main-nav a { padding: 8px; gap: 0; }
        .site-title { display: none; }
        .main-nav { margin-left: 8px; gap: 8px; }
        .header-right { gap: 8px; }
        header.app-header{ padding: 0 16px; }

        /* Show mobile hamburger menu button */
        .mobile-menu-btn { display: inline-flex; }

        .sidebar-toggle-mobile {
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 56px;
            height: 56px;
            background: var(--accent);
            color: #fff;
            border-radius: 50%;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            z-index: 1100;
            cursor: pointer;
        }
        .sidebar-toggle-mobile i { font-size: 20px; }

        .sidebar {
            position: fixed;
            top: 72px;
            height: calc(100vh - 72px);
            transform: translateX(-100%);
        }
        .main-content { margin-left: 0; }
        .modal-content { width: 95%; padding: 1rem; }
      }
      
      /* NEW: Styles to shrink logo on small mobile screens */
      @media (max-width: 480px) {
        .logo {
          max-height: 36px; /* Reduce logo height */
        }
        .brand {
          gap: 8px; /* Reduce space next to logo */
        }
        header.app-header {
          padding: 0 12px; /* Reduce header padding */
        }
        .header-right {
          gap: 4px; /* Reduce gap between right-side icons */
        }
      }

      /* Chỉ áp dụng cho thiết bị cảm ứng để không ảnh hưởng keyboard users */
      @media (pointer: coarse) {
        * {
          -webkit-tap-highlight-color: transparent; /* iOS, Chrome mobile */
          -webkit-touch-callout: none;              /* tắt menu giữ chạm (iOS) nếu cần */
        }
      }
    </style>
</head>
<body style="display: none;">

  <header class="app-header">
    <div style="display:flex;align-items:center;">
      <div class="brand">
        <img src="../fde8b58d-513b-45b3-9a8b-8a81e7535bec.jpg" alt="WordWhizzy Logo" class="logo">
      </div>
      <nav class="main-nav" aria-label="Chính">
        <a href="../index.html" title="Trang chủ"><i class="fa-solid fa-house"></i> <span>Trang chủ</span></a>
        <a href="../tuhoc.html" title="Thư viện"><i class="fa-solid fa-book-open"></i> <span>Thư viện</span></a>
        <a href="./vocabulary.html" title="Tạo Flashcard" class="active"><i class="fa-solid fa-layer-group"></i> <span>Flashcard</span></a>
        <a href="../chatai.html" title="Chat AI"><i class="fa-solid fa-comments"></i> <span>Chat AI</span></a>
        <a href="../roomchat.html" title="Room Chat"><i class="fa-solid fa-users"></i> <span>Room Chat</span></a>
       
      </nav>
    </div>

    <div class="header-right">
      <a href="../thongbao.html" class="icon-btn" id="btn-noti" title="Thông báo"><i class="fa-regular fa-bell"></i></a>
      <div class="icon-btn" id="btn-help" title="Trợ giúp"><i class="fa-regular fa-circle-question"></i></div>
      
      <div class="icon-btn mobile-menu-btn" id="mobileMenuBtn">
        <i class="fa-solid fa-ellipsis-vertical"></i>
        <div class="mobile-menu-dropdown" id="mobileMenuDropdown">
          <a href="../chatai.html" title="Chat AI"><i class="fa-solid fa-comments"></i> <span>Chat AI</span></a>
          <a href="../roomchat.html" title="Room Chat"><i class="fa-solid fa-users"></i> <span>Room Chat</span></a>
          
        </div>
      </div>

      <div class="user-display" id="headerControls"></div>
    </div>
  </header>
  <div class="sidebar-toggle-mobile" onclick="toggleSidebar()">
      <i class="fa-solid fa-bars"></i>
  </div>

  <div class="app-container">
      <aside class="sidebar">
        <nav class="days-nav">
          <div class="day-item active" onclick="showDay(1)">
            <i class="fa-solid fa-calendar-days"></i>
            <span>Day 1</span>
            <span class="count" id="count-1">0</span>
          </div>
          <div class="day-item" onclick="showDay(2)">
            <i class="fa-solid fa-calendar-days"></i>
            <span>Day 2</span>
            <span class="count" id="count-2">0</span>
          </div>
          <div class="day-item" onclick="showDay(3)">
            <i class="fa-solid fa-calendar-days"></i>
            <span>Day 3</span>
            <span class="count" id="count-3">0</span>
          </div>
          <div class="day-item" onclick="showDay(4)">
            <i class="fa-solid fa-calendar-days"></i>
            <span>Day 4</span>
            <span class="count" id="count-4">0</span>
          </div>
          <div class="day-item" onclick="showDay(5)">
            <i class="fa-solid fa-calendar-days"></i>
            <span>Day 5</span>
            <span class="count" id="count-5">0</span>
          </div>
          <div class="day-item" onclick="showDay(6)">
            <i class="fa-solid fa-calendar-days"></i>
            <span>Day 6</span>
            <span class="count" id="count-6">0</span>
          </div>
          <div class="day-item" onclick="showDay(7)">
            <i class="fa-solid fa-calendar-days"></i>
            <span>Day 7</span>
            <span class="count" id="count-7">0</span>
          </div>
          <div class="day-item" onclick="showLargeFolders()">
            <i class="fa-solid fa-folder-open"></i>
            <span>Large Folders</span>
            <span class="count" id="count-large">0</span>
          </div>
        </nav>
      </aside>

      <main class="main-content">
        <div class="content-header">
          <div class="header-actions">
            <h2 id="currentDayTitle">Day 1</h2>
            <div>
              <button class="btn btn-secondary" onclick="toggleCreateForm()" id="createFolderBtn">
                <i class="fa-solid fa-plus"></i> Create Folder
              </button>
              <button class="btn btn-primary" onclick="toggleCreateLargeFolderForm()" id="createLargeFolderBtn" style="display: none">
                <i class="fa-solid fa-folder-plus"></i> Create Large Folder
              </button>
            </div>
          </div>

          <div class="create-form" id="createForm" style="display: none">
            <div class="form-group">
              <label for="folderName">Folder Name</label>
              <input type="text" id="folderName" placeholder="e.g., Business English"/>
            </div>
            <div class="form-group">
              <label for="description">Description</label>
              <textarea id="description" placeholder="A brief description for this vocabulary set."></textarea>
            </div>
            <button class="btn btn-primary" onclick="createFolder()"><i class="fa-solid fa-check"></i> Confirm & Create</button>
          </div>

          <div class="create-form" id="createLargeFolderForm" style="display: none">
            <div class="form-group">
              <label for="largeFolderName">Large Folder Name</label>
              <input type="text" id="largeFolderName" placeholder="e.g., IELTS Preparation"/>
            </div>
            <div class="form-group">
               <label for="largeFolderTheme">Theme</label>
              <input type="text" id="largeFolderTheme" placeholder="e.g., Academic, Travel"/>
            </div>
            <button class="btn btn-primary" onclick="createLargeFolder()"><i class="fa-solid fa-check"></i> Confirm & Create</button>
          </div>
        </div>

        <div id="folderContainer" class="folder-grid"></div>
        <div id="largeFolderContainer" class="large-folder-grid" style="display: none"></div>
      </main>
  </div>

    <div id="wordModal" class="modal" style="display: none;">
      <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
          <h3 class="modal-title" id="modalTitle">Folder Words</h3>
          <span class="close" onclick="closeWordModal()">×</span>
        </div>
        <div class="word-list" id="wordList"></div>
        <div class="form-group">
          <label for="newWord">New Word</label>
          <input type="text" id="newWord" placeholder="Enter a new word" />
        </div>
        <div class="form-group">
          <label for="newDefinition">Definition</label>
          <input type="text" id="newDefinition" placeholder="Enter the definition"/>
        </div>
        <button class="btn btn-primary" onclick="addWord()"><i class="fa-solid fa-plus"></i> Add Word</button>
      </div>
    </div>

    <div class="notification" id="notification"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
      // --- Firebase init ---
      const firebaseConfig = {
        apiKey: "AIzaSyAm-p5xIzMi7Rkt6y9TzODJLFjdpLKBIlg",
        authDomain: "wordwhizzy.firebaseapp.com",
        projectId: "wordwhizzy",
        storageBucket: "wordwhizzy.appspot.com",
        messagingSenderId: "179575783469",
        appId: "1:179575783469:web:30d0ae652af3cfda4bb8a4",
        measurementId: "G-XPFQ8PCTRE",
      };
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      const auth = firebase.auth();
      const db = firebase.firestore();
      const storage = firebase.storage();
      
      // --- GLOBAL STATE ---
      let folders = { day1: [], day2: [], day3: [], day4: [], day5: [], day6: [], day7: [], largeFolders: [] };
      let currentUser = null; 
      const MOVE_INTERVAL = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
      let currentDay = 1;
      let currentMode = "day";
      let timeoutIds = {};
      let currentFolderId = null;
      
      // --- Settings Popup & User Profile Logic (from index.html) ---
      async function getUserProfile(uid) {
        try {
          const docRef = db.collection("users").doc(uid);
          const docSnap = await docRef.get();
          return docSnap.exists ? docSnap.data() : null;
        } catch (e) { console.error('getUserProfile error', e); return null; }
      }
      
      async function saveUserProfile(uid, data) {
        try {
          await db.collection("users").doc(uid).set(data, { merge: true });
        } catch (e) { console.error('saveUserProfile error', e); }
      }
      
      async function uploadAvatar(file, uid) {
        const storageRef = storage.ref(`avatars/${uid}/${file.name}`);
        const snapshot = await storageRef.put(file);
        return await snapshot.ref.getDownloadURL();
      }

      const settingsPopupHTML = `
        <div class="overlay modal" id="settingsPopupOverlay" style="display:none;">
          <div class="modal-content" style="max-width: 520px;">
            <h3>Cài đặt tài khoản</h3>
            <span class="close" id="closeSettingsPopup" style="position: absolute; top: 1rem; right: 1.5rem;">×</span>
            <form id="settingsForm" style="margin-top:16px">
              <div style="display:flex;flex-direction:column;align-items:center;gap:8px;margin-bottom:16px">
                <img id="currentAvatar" src="https://via.placeholder.com/100/cccccc/ffffff?text=AV" alt="Avatar" style="width:100px;height:100px;border-radius:50%;object-fit:cover;border:1px solid var(--border)">
                <input type="file" id="avatarUpload" accept="image/*" />
              </div>
              <div style="display:flex;flex-direction:column;gap:10px">
                <label style="font-size:14px;font-weight:500;">Tên hiển thị</label>
                <input id="displayName" type="text" style="padding:10px;border-radius:8px;border:1px solid var(--border)"/>
                <label style="font-size:14px;font-weight:500;">Ngày sinh</label>
                <input id="dob" type="date" style="padding:10px;border-radius:8px;border:1px solid var(--border)"/>
                <label style="font-size:14px;font-weight:500;">Lớp / Trình độ</label>
                <input id="classGrade" type="text" placeholder="Ví dụ: Intermediate" style="padding:10px;border-radius:8px;border:1px solid var(--border)"/>
              </div>
              <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
                <button class="btn btn-primary" type="submit">Lưu thay đổi</button>
              </div>
            </form>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', settingsPopupHTML);

      const settingsPopup = document.getElementById("settingsPopupOverlay");
      document.getElementById("closeSettingsPopup")?.addEventListener("click", () => { settingsPopup.style.display = "none"; });
      settingsPopup.addEventListener('click', (e) => { if(e.target === settingsPopup) settingsPopup.style.display = 'none'; })

      async function showSettingsPopup(user) {
        settingsPopup.style.display = "flex";
        const userProfile = await getUserProfile(user.uid);
        const displayNameInput = document.getElementById("displayName");
        const dobInput = document.getElementById("dob");
        const classGradeInput = document.getElementById("classGrade");
        const currentAvatar = document.getElementById("currentAvatar");
        if (userProfile) {
          currentAvatar.src = userProfile.avatarURL || user.photoURL || "https://via.placeholder.com/100";
          displayNameInput.value = userProfile.displayName || user.displayName || "";
          dobInput.value = userProfile.dob || "";
          classGradeInput.value = userProfile.classGrade || "";
        } else {
          currentAvatar.src = user.photoURL || "https://via.placeholder.com/100";
          displayNameInput.value = user.displayName || "";
        }
      }

      document.getElementById("settingsForm")?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const user = auth.currentUser;
        if (!user) return;
        const newDisplayName = document.getElementById("displayName").value;
        const newDob = document.getElementById("dob").value;
        const newClassGrade = document.getElementById("classGrade").value;
        const avatarFile = document.getElementById("avatarUpload").files[0];
        let newAvatarURL = document.getElementById("currentAvatar").src;
        try {
          if (avatarFile) newAvatarURL = await uploadAvatar(avatarFile, user.uid);
          await user.updateProfile({ displayName: newDisplayName, photoURL: newAvatarURL });
          await saveUserProfile(user.uid, { displayName: newDisplayName, avatarURL: newAvatarURL, dob: newDob, classGrade: newClassGrade });
          alert("Cập nhật thành công!");
          settingsPopup.style.display = "none";
          window.location.reload();
        } catch (err) { alert("Lỗi: " + err.message); }
      });
      
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          document.body.style.display = "block";
          currentUser = { uid: user.uid, name: user.displayName || 'User' };
          
          await loadData(); 
          
          const headerControls = document.getElementById("headerControls");
          headerControls.innerHTML = "";
          let userProfile = await getUserProfile(user.uid);
          let photoURL = (userProfile && userProfile.avatarURL) ? userProfile.avatarURL : (user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName || 'U'}&background=random`);
          const userDisplay = document.createElement("div");
          userDisplay.className = "user-display";
          userDisplay.innerHTML = `<img src="${photoURL}" alt="Avatar" id="userAvatar"><div id="userDropdown" style="display:none;position:absolute;right:22px;top:74px;background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:8px;box-shadow:var(--shadow); z-index:1300; width: 180px;"></div>`;
          headerControls.appendChild(userDisplay);
          const userDropdown = document.getElementById('userDropdown');
          if (userDropdown) {
            userDropdown.innerHTML = `
              <div style="padding: 8px 12px; border-bottom: 1px solid var(--border); margin-bottom: 8px;">
                  <div style="font-weight:600;font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${user.displayName || 'Người dùng'}</div>
                  <div class="tiny muted" style="font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${user.email}</div>
              </div>
              <a href="#" id="settingsBtn" style="display:flex; align-items:center; gap:8px; padding:8px 12px;border-radius:8px;color:var(--text-muted); font-size:14px; font-weight:500;"><i class="fa-solid fa-gear" style="width:16px;"></i>Cài đặt</a>
              <a href="#" id="logoutBtn" style="display:flex; align-items:center; gap:8px; padding:8px 12px;border-radius:8px;color:var(--text-muted); font-size:14px; font-weight:500;"><i class="fa-solid fa-arrow-right-from-bracket" style="width:16px;"></i>Đăng xuất</a>
            `;
            userDropdown.querySelectorAll('a').forEach(link => {
              link.onmouseover = () => { link.style.backgroundColor = 'var(--bg-soft)'; link.style.color='var(--accent)'};
              link.onmouseout = () => { link.style.backgroundColor = 'transparent'; link.style.color='var(--text-muted)'};
            });
          }
           
           userDisplay.addEventListener('click', () => { if (userDropdown) userDropdown.style.display = userDropdown.style.display === 'block' ? 'none' : 'block'; });
           document.addEventListener('click', (ev) => {
             if (!ev.target.closest('.user-display') && !ev.target.closest('.mobile-menu-btn')) { 
               if (userDropdown) userDropdown.style.display = 'none';
               const mobileMenuDropdown = document.getElementById('mobileMenuDropdown');
               if (mobileMenuDropdown) mobileMenuDropdown.style.display = 'none';
             }
           });
           
           document.getElementById('logoutBtn')?.addEventListener('click', async (ev) => { ev.preventDefault(); await auth.signOut(); window.location.href = '../login.html'; });
           document.getElementById('settingsBtn')?.addEventListener('click', (ev) => { ev.preventDefault(); if (userDropdown) userDropdown.style.display = 'none'; showSettingsPopup(user); });
        } else {
          window.location.href = '../login.html';
        }
      });
      
      // NEW: Mobile Hamburger Menu Logic
      const mobileMenuBtn = document.getElementById('mobileMenuBtn');
      const mobileMenuDropdown = document.getElementById('mobileMenuDropdown');
      if(mobileMenuBtn) {
        mobileMenuBtn.addEventListener('click', (e) => {
          e.stopPropagation(); // Prevent the document click listener from firing immediately
          mobileMenuDropdown.style.display = mobileMenuDropdown.style.display === 'block' ? 'none' : 'block';
        });
      }

      async function loadData() {
        if (!currentUser || !currentUser.uid) return;
        try {
          const userDocRef = db.collection("users").doc(currentUser.uid);
          const doc = await userDocRef.get();
          if (doc.exists) {
            folders = { day1: [], day2: [], day3: [], day4: [], day5: [], day6: [], day7: [], largeFolders: [], ...doc.data().folders };
            // Ensure all day arrays exist to prevent errors
             for (let i = 1; i <= 7; i++) {
                if (!folders[`day${i}`]) folders[`day${i}`] = [];
            }
            if (!folders.largeFolders) folders.largeFolders = [];
            
            checkAndUpdateFolders();
          } else {
            await saveData();
          }
          updateAllCounts();
          updateDisplay();
        } catch (error) { console.error("Error loading data:", error); showNotification("Error loading data.", "error"); }
      }

      async function saveData() {
        if (!currentUser || !currentUser.uid) return;
        try {
          // Clear all existing timers before saving and restarting them
          Object.values(timeoutIds).forEach(clearTimeout);
          timeoutIds = {};
          
          await db.collection("users").doc(currentUser.uid).set({ folders: folders }, { merge: true });
          
          // After saving, restart timers for all folders
          for (let i = 1; i <= 7; i++) {
             if (folders[`day${i}`]) {
                folders[`day${i}`].forEach(startFolderTimer);
             }
          }
          updateAllCounts();
        } catch (error) { console.error("Error saving data:", error); showNotification("Error saving data.", "error"); }
      }

      window.toggleCreateForm = () => { document.getElementById("createForm").style.display = document.getElementById("createForm").style.display === "none" ? "block" : "none"; }
      window.toggleCreateLargeFolderForm = () => { document.getElementById("createLargeFolderForm").style.display = document.getElementById("createLargeFolderForm").style.display === "none" ? "block" : "none"; }

      window.createFolder = () => {
        const name = document.getElementById("folderName").value.trim();
        const description = document.getElementById("description").value.trim();
        if (!name) { showNotification("Please enter a folder name!", "warning"); return; }
        const now = new Date().toISOString();
        const folder = { 
            name, 
            description: description || "No description", 
            currentDay: 1, 
            id: Date.now(), 
            creator: currentUser.name, 
            wordCount: 0, 
            createdAt: now, 
            lastMoved: now // Important: Set lastMoved on creation
        };
        if(!folders.day1) folders.day1 = [];
        folders.day1.push(folder);
        saveData(); 
        updateDisplay();
        document.getElementById("folderName").value = ""; 
        document.getElementById("description").value = "";
        toggleCreateForm(); 
        showNotification("Folder created successfully!", "success");
      }
      
      window.createLargeFolder = () => {
        const name = document.getElementById("largeFolderName").value.trim();
        const theme = document.getElementById("largeFolderTheme").value.trim();
        if (!name) { showNotification("Please enter a name!", "warning"); return; }
        const largeFolder = { name, theme: theme || "General", id: Date.now(), creator: currentUser.name, createdAt: new Date().toISOString(), subfolders: [] };
        if(!folders.largeFolders) folders.largeFolders = [];
        folders.largeFolders.push(largeFolder);
        saveData(); updateDisplay();
        document.getElementById("largeFolderName").value = ""; document.getElementById("largeFolderTheme").value = "";
        toggleCreateLargeFolderForm(); showNotification("Large folder created successfully!", "success");
      }

      // --- FOLDER MOVEMENT LOGIC ---
      function checkAndUpdateFolders() {
        const now = Date.now();
        let needsSave = false;
        for (let day = 1; day < 7; day++) {
          const currentDayFolders = [...(folders[`day${day}`] || [])]; 
          currentDayFolders.forEach(folder => {
            const lastMovedTime = new Date(folder.lastMoved).getTime();
            const timeDiff = now - lastMovedTime;
            
            if (timeDiff >= MOVE_INTERVAL) {
              const daysToMove = Math.floor(timeDiff / MOVE_INTERVAL);
              const newDay = Math.min(7, day + daysToMove);
              const newLastMoved = new Date(lastMovedTime + daysToMove * MOVE_INTERVAL).toISOString();

              // Remove from old day
              folders[`day${day}`] = folders[`day${day}`].filter(f => f.id !== folder.id);
              
              // Update folder properties
              folder.currentDay = newDay;
              folder.lastMoved = newLastMoved;

              // Add to new day
              if (!folders[`day${newDay}`]) folders[`day${newDay}`] = [];
              folders[`day${newDay}`].push(folder);
              needsSave = true;
            }
          });
        }
        if (needsSave) {
          saveData().then(() => {
             updateDisplay();
             showNotification("Folders have been updated based on your progress!", "info");
          });
        } else {
             // Still need to start timers even if no moves happened
            for (let i = 1; i <= 7; i++) {
                (folders[`day${i}`] || []).forEach(startFolderTimer);
            }
        }
      }

      function startFolderTimer(folder) {
        if (timeoutIds[folder.id]) {
            clearTimeout(timeoutIds[folder.id]);
        }
        if (folder.currentDay >= 7) return;

        const timeSinceLastMove = Date.now() - new Date(folder.lastMoved).getTime();
        const timeUntilNextMove = MOVE_INTERVAL - timeSinceLastMove;

        if (timeUntilNextMove > 0) {
            timeoutIds[folder.id] = setTimeout(() => {
                moveFolder(folder.id);
            }, timeUntilNextMove);
        } else {
            // If overdue, move immediately
            moveFolder(folder.id);
        }
      }

      function moveFolder(folderId) {
        let folder, oldDay;
        // Find folder and its day
        for (let i = 1; i <= 7; i++) {
          const found = (folders[`day${i}`] || []).find(f => f.id === folderId);
          if (found) {
            folder = found;
            oldDay = i;
            break;
          }
        }

        if (!folder || oldDay >= 7) return;

        // Remove from the old day's array
        folders[`day${oldDay}`] = folders[`day${oldDay}`].filter(f => f.id !== folderId);
        
        // Update properties and move to the new day's array
        const newDay = oldDay + 1;
        folder.currentDay = newDay;
        folder.lastMoved = new Date().toISOString();
        if(!folders[`day${newDay}`]) folders[`day${newDay}`] = [];
        folders[`day${newDay}`].push(folder);
        
        saveData();
        updateDisplay();
        showNotification(`'${folder.name}' moved to Day ${newDay}.`, "info");
      }

      window.studyAndResetFolder = (folderId) => {
        let folder, oldDay;
        for (let i = 1; i <= 7; i++) {
            const found = (folders[`day${i}`] || []).find(f => f.id === folderId);
            if (found) {
                folder = found;
                oldDay = i;
                break;
            }
        }

        if (!folder) return;
        
        // If it's not already in day 1, move it
        if (oldDay !== 1) {
            folders[`day${oldDay}`] = folders[`day${oldDay}`].filter(f => f.id !== folderId);
            folder.currentDay = 1;
            folder.lastMoved = new Date().toISOString();
            if (!folders.day1) folders.day1 = [];
            folders.day1.push(folder);
        }

        saveData().then(() => {
            updateDisplay();
            showNotification(`'${folder.name}' has been reset to Day 1. Good luck!`, "success");
            // Proceed to the study page
            window.location.href = `study-options.html?id=${folderId}`;
        });
      };
      
      function showNotification(message, type = "info") {
        const n = document.getElementById("notification");
        n.textContent = message;
        n.style.backgroundColor = type === "success" ? "var(--success)" : type === "error" ? "var(--error)" : type === "warning" ? "var(--warning)" : "var(--accent)";
        n.classList.add("show");
        setTimeout(() => n.classList.remove("show"), 3500);
      }

      window.toggleSidebar = () => document.querySelector(".sidebar").classList.toggle("active");
      
      window.deleteFolder = async (id) => {
        if (!confirm("Are you sure you want to delete this folder? This cannot be undone.")) return;
        try {
          // Delete associated flashcards first
          await db.collection("users").doc(currentUser.uid).collection("flashcards").doc(id.toString()).delete();
        } catch (error) { 
            console.error("Error deleting flashcards subcollection, it might not exist:", error); 
        }
        
        // Remove from local state
        for (let i = 1; i <= 7; i++) { if(folders[`day${i}`]) folders[`day${i}`] = folders[`day${i}`].filter((f) => f.id !== id); }
        if(folders.largeFolders) folders.largeFolders.forEach((lf) => { if(lf.subfolders) lf.subfolders = lf.subfolders.filter((sf) => sf.id !== id); });
        
        // Save the updated state
        saveData(); 
        updateDisplay(); 
        showNotification("Folder deleted!", "success");
      }
      
      window.deleteLargeFolder = (id) => {
        if (!confirm("Are you sure you want to delete this large folder? Subfolders will not be deleted.")) return;
        folders.largeFolders = (folders.largeFolders || []).filter(lf => lf.id !== id);
        saveData();
        updateDisplay();
        showNotification("Large folder deleted!", "success");
      }

      function updateAllCounts() {
        for (let i = 1; i <= 7; i++) document.getElementById(`count-${i}`).textContent = (folders[`day${i}`] || []).length;
        document.getElementById("count-large").textContent = (folders.largeFolders || []).length;
      }
      
      window.showDay = (day) => {
        currentDay = day;
        currentMode = "day";
        document.getElementById("currentDayTitle").textContent = `Day ${day}`;
        document.querySelectorAll(".day-item").forEach((item) => item.classList.remove("active"));
        document.querySelector(`.days-nav .day-item:nth-child(${day})`).classList.add("active");
        document.getElementById("folderContainer").style.display = "grid"; document.getElementById("largeFolderContainer").style.display = "none";
        document.getElementById("createFolderBtn").style.display = "inline-flex"; document.getElementById("createLargeFolderBtn").style.display = "none";
        if (window.innerWidth <= 820 && document.querySelector(".sidebar").classList.contains("active")) toggleSidebar();
        updateDisplay();
      }

      window.showLargeFolders = () => {
        currentMode = "large";
        document.getElementById("currentDayTitle").textContent = "Large Folders";
        document.querySelectorAll(".day-item").forEach((item) => item.classList.remove("active"));
        document.querySelector(`.days-nav .day-item:last-child`).classList.add("active");
        document.getElementById("folderContainer").style.display = "none"; document.getElementById("largeFolderContainer").style.display = "grid";
        document.getElementById("createFolderBtn").style.display = "none";
        document.getElementById("createLargeFolderBtn").style.display = "inline-flex";
        if (window.innerWidth <= 820 && document.querySelector(".sidebar").classList.contains("active")) toggleSidebar();
        updateDisplay();
      }
      
      function updateDisplay() {
        if (currentMode === "day") updateFolderDisplay();
        else updateLargeFolderDisplay();
        updateAllCounts();
      }

      function updateFolderDisplay() {
        const container = document.getElementById("folderContainer");
        const currentFolders = folders[`day${currentDay}`] || [];
        if (currentFolders.length === 0) {
          container.innerHTML = `<div class="empty-state"><h3>No Folders Here</h3><p>Create a new folder to get started.</p></div>`;
          return;
        }
        container.innerHTML = currentFolders.map((folder) => {
            const hasWords = folder.wordCount > 0;
            const createdDate = new Date(folder.createdAt).toLocaleDateString();
            return `
              <div class="folder-card">
                <div class="folder-header"><h3 class="folder-title">${folder.name}</h3><span class="folder-day">Day ${folder.currentDay}</span></div>
                <p class="folder-description">${folder.description}</p>
                 <div class="folder-stats">
                  <div class="stats-item"><span><i class="fa-solid fa-book"></i> Words</span><span>${folder.wordCount || 0}</span></div>
                  <div class="stats-item"><span><i class="fa-solid fa-user"></i> Creator</span><span>${folder.creator}</span></div>
                  <div class="stats-item"><span><i class="fa-solid fa-calendar-plus"></i> Created</span><span>${createdDate}</span></div>
                </div>
                <div class="progress-container"><div class="progress-bar" style="width: ${(folder.currentDay / 7) * 100}%"></div></div>
                <div class="folder-actions">
                   ${hasWords 
                      ? `<button class="btn btn-secondary" onclick="showWordModal(${folder.id}, '${folder.name}')"><i class="fa-solid fa-eye"></i> View</button>
                         <button class="btn btn-primary" onclick="studyAndResetFolder(${folder.id})"><i class="fa-solid fa-graduation-cap"></i> Study</button>` 
                      : `<button class="btn btn-primary" onclick="window.location.href='vocabulary-input.html?id=${folder.id}'"><i class="fa-solid fa-plus"></i> Add Words</button>`
                   }
                  <button class="btn btn-secondary" onclick="showEditModal(${folder.id})"><i class="fa-solid fa-pen"></i></button>
                  <button class="btn btn-secondary" style="color: var(--error);" onclick="deleteFolder(${folder.id})"><i class="fa-solid fa-trash"></i></button>
                </div>
              </div>`;
        }).join("");
      }

      function updateLargeFolderDisplay() {
        const c = document.getElementById("largeFolderContainer");
        const lfs = folders.largeFolders || [];
        if (lfs.length === 0) { c.innerHTML = `<div class="empty-state"><h3>No Large Folders</h3><p>Group related folders here.</p></div>`; return; }
        c.innerHTML = lfs.map((lf) => `
              <div class="large-folder-card">
                <div class="large-folder-header"><h3 class="large-folder-title">${lf.name}</h3><span class="folder-day">${lf.theme}</span></div>
                <div class="large-folder-stats">
                  <div class="stats-item"><span><i class="fa-solid fa-folder"></i> Subfolders</span> <span>${(lf.subfolders || []).length}</span></div>
                   <div class="stats-item"><span><i class="fa-solid fa-book"></i> Total Words</span> <span>${(lf.subfolders || []).reduce((s, sf) => s + (sf.wordCount || 0),0)}</span></div>
                </div>
                <div class="large-folder-actions">
                  <button class="btn btn-primary" onclick="showSubfolderModal(${lf.id}, '${lf.name}')"><i class="fa-solid fa-pen-to-square"></i> Manage</button>
                  <button class="btn btn-secondary" style="color: var(--error);" onclick="deleteLargeFolder(${lf.id})"><i class="fa-solid fa-trash"></i> Delete</button>
                </div>
              </div>`).join("");
      }

      window.showWordModal = async (folderId, folderName) => {
        currentFolderId = folderId;
        const modal = document.getElementById("wordModal");
        document.getElementById("modalTitle").textContent = `Words in "${folderName}"`;
        document.getElementById("wordList").innerHTML = "<p>Loading...</p>";
        modal.style.display = "flex";
        try {
          const doc = await db.collection("users").doc(currentUser.uid).collection("flashcards").doc(folderId.toString()).get();
          const flashcards = (doc.exists && doc.data().words) ? doc.data().words : [];
          document.getElementById("wordList").innerHTML = flashcards.length ? flashcards.map(w => `<div class="word-item"><span class="word-term">${w.word}</span><span class="word-definition">${w.meaning}</span></div>`).join("") : "<p>No words yet. Add one!</p>";
          document.getElementById("newWord").value = ""; document.getElementById("newDefinition").value = "";
        } catch (error) { document.getElementById("wordList").innerHTML = "<p>Error loading vocabulary.</p>"; }
      }

      window.closeWordModal = () => { document.getElementById("wordModal").style.display = "none"; currentFolderId = null; }

      window.addWord = async () => {
        const newWord = document.getElementById("newWord").value.trim();
        const newDefinition = document.getElementById("newDefinition").value.trim();

        if (!newWord || !newDefinition) {
            showNotification("Please provide both a word and a definition.", "warning");
            return;
        }
        if (!currentFolderId) return;

        const flashcardsRef = db.collection("users").doc(currentUser.uid).collection("flashcards").doc(currentFolderId.toString());
        
        try {
            await db.runTransaction(async (transaction) => {
                const doc = await transaction.get(flashcardsRef);
                const words = (doc.exists && doc.data().words) ? doc.data().words : [];
                words.push({ word: newWord, meaning: newDefinition });
                transaction.set(flashcardsRef, { words: words }, { merge: true });

                // Now, update the wordCount in the main user document
                let folderToUpdate, dayKey;
                for (let i = 1; i <= 7; i++) {
                   const key = `day${i}`;
                   const found = (folders[key] || []).find(f => f.id === currentFolderId);
                   if (found) {
                       folderToUpdate = found;
                       dayKey = key;
                       break;
                   }
                }
                
                if (folderToUpdate) {
                    folderToUpdate.wordCount = words.length;
                    // This update happens locally first, then is saved via saveData()
                }
            });

            await saveData(); // Save the updated folders object with new wordCount
            updateDisplay(); // Refresh the main display to show new word count
            showNotification("Word added successfully!", "success");
            
            // Refresh the modal view
            const folderName = document.getElementById("modalTitle").textContent.replace('Words in "', '').replace('"', '');
            showWordModal(currentFolderId, folderName);

        } catch (error) {
            console.error("Error adding word: ", error);
            showNotification("Failed to add word.", "error");
        }
      }

    window.showEditModal = (folderId) => {
        let folder;
        for (let i = 1; i <= 7; i++) {
            const found = (folders[`day${i}`] || []).find(f => f.id === folderId);
            if (found) {
                folder = found;
                break;
            }
        }
        if (!folder) return;

        const modal = document.createElement("div");
        modal.className = "modal";
        modal.style.display = "flex";
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); }
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
              <h3 class="modal-title">Edit Folder</h3>
              <span class="close" onclick="this.closest('.modal').remove()">×</span>
            </div>
            <div class="form-group">
              <label for="editFolderName">Folder Name</label>
              <input type="text" id="editFolderName" value="${folder.name}" />
            </div>
            <div class="form-group">
              <label for="editFolderDesc">Description</label>
              <textarea id="editFolderDesc">${folder.description}</textarea>
            </div>
            <button class="btn btn-primary" onclick="updateFolder(${folder.id}, this)"><i class="fas fa-save"></i> Save Changes</button>
          </div>
        `;
        document.body.appendChild(modal);
    }

    window.updateFolder = (folderId, buttonElement) => {
        const modal = buttonElement.closest('.modal');
        const newName = modal.querySelector('#editFolderName').value.trim();
        const newDesc = modal.querySelector('#editFolderDesc').value.trim();

        if (!newName) {
            showNotification("Folder name cannot be empty.", "warning");
            return;
        }

        let folder;
        for (let i = 1; i <= 7; i++) {
            const found = (folders[`day${i}`] || []).find(f => f.id === folderId);
            if (found) {
                folder = found;
                break;
            }
        }
        if (folder) {
            folder.name = newName;
            folder.description = newDesc;
            saveData();
            updateDisplay();
            modal.remove();
            showNotification("Folder updated successfully!", "success");
        }
    }


      window.showSubfolderModal = (largeFolderId, largeFolderName) => {
        const largeFolder = (folders.largeFolders || []).find(lf => lf.id === largeFolderId);
        if (!largeFolder) return;
        const allFolders = [];
        for (let day = 1; day <= 7; day++) { (folders[`day${day}`] || []).forEach(folder => allFolders.push({ ...folder, day: day })); }
        const subfoldersInLargeFolder = largeFolder.subfolders || [];
        const modal = document.createElement("div");
        modal.className = "modal";
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); }
        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title">Manage Subfolders in ${largeFolderName}</h3>
              <span class="close" onclick="this.closest('.modal').remove()">×</span>
            </div>
            <label class="form-group-label">Current Subfolders:</label>
             <div class="subfolder-grid" id="subfolderList" style="margin-bottom: 1.5rem;">
              ${subfoldersInLargeFolder.length ? subfoldersInLargeFolder.map(sf => `
                  <div class="subfolder-card" style="padding: 1rem;">
                    <h3 class="subfolder-title">${sf.name}</h3>
                    <p class="subfolder-description" style="margin: 0.5rem 0;">${sf.wordCount || 0} words</p>
                    <div class="subfolder-actions">
                       <button class="btn btn-secondary" style="color: var(--error);" onclick="removeSubfolder(${largeFolderId}, ${sf.id}, this)"><i class="fas fa-trash"></i> Remove</button>
                    </div>
                  </div>`).join("") : "<p>No subfolders yet.</p>"}
            </div>
            <label class="form-group-label">Add Available Folders:</label>
             <div class="folder-list-container">
              ${allFolders.length ? allFolders.map(folder => `
                  <div class="folder-checkbox">
                    <input type="checkbox" id="subfolder_${folder.id}" value="${folder.id}" data-day="${folder.day}" ${subfoldersInLargeFolder.some(sf => sf.id === folder.id) ? "disabled" : ""}>
                    <label for="subfolder_${folder.id}">${folder.name} (Day ${folder.day})</label>
                  </div>`).join("") : "<p>No other folders available.</p>"}
            </div>
            <button class="btn btn-primary" onclick="addSubfolder(${largeFolderId}, this)"><i class="fas fa-plus"></i> Add Selected</button>
          </div>
        `;
        document.body.appendChild(modal);
      }

      window.addSubfolder = (largeFolderId, buttonElement) => {
        const largeFolder = folders.largeFolders.find(lf => lf.id === largeFolderId);
        if (!largeFolder) return;
        const modalContent = buttonElement.closest(".modal-content");
        const checkboxes = modalContent.querySelectorAll('input[type="checkbox"]:checked');
        if (checkboxes.length === 0) { showNotification("Please select a folder to add.", "warning"); return; }
        if (!largeFolder.subfolders) largeFolder.subfolders = [];
        checkboxes.forEach((checkbox) => {
          const folderId = parseInt(checkbox.value);
          const day = parseInt(checkbox.dataset.day);
          const folder = folders[`day${day}`].find(f => f.id === folderId);
          if (folder && !largeFolder.subfolders.some(sf => sf.id === folderId)) {
            largeFolder.subfolders.push({ ...folder });
          }
        });
        saveData(); updateDisplay();
        showNotification("Subfolders added!", "success");
        buttonElement.closest(".modal").remove();
      }

      window.removeSubfolder = (largeFolderId, subfolderId, buttonElement) => {
        const largeFolder = folders.largeFolders.find(lf => lf.id === largeFolderId);
        if (!largeFolder || !largeFolder.subfolders) return;
        largeFolder.subfolders = largeFolder.subfolders.filter(sf => sf.id !== subfolderId);
        saveData(); updateDisplay();
        showNotification("Subfolder removed!", "success");
        buttonElement.closest(".modal").remove();
      }
    </script>
</body>
</html>