<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ôn tập từ đã lưu | Vocabulary Manager</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <script src="https://unpkg.com/franc-min@6.2.0/franc-min.js"></script>
    <style>
    
    /* Chỉ áp dụng cho thiết bị cảm ứng để không ảnh hưởng keyboard users */
@media (pointer: coarse) {
  * {
    -webkit-tap-highlight-color: transparent; /* iOS, Chrome mobile */
    -webkit-touch-callout: none;              /* tắt menu giữ chạm (iOS) nếu cần */
  }
}

      :root {
        --primary-color: #60a5fa; /* Light blue */
        --secondary-color: #2563eb; /* Darker blue */
        --background: #f0f4f8; /* Light gray-blue background */
        --card-bg: #ffffff; /* White cards */
        --text-primary: #1e293b; /* Dark text */
        --text-secondary: #64748b; /* Gray text */
        --shadow: 0 6px 25px rgba(0, 0, 0, 0.06); /* Soft shadow */
        --success: #22c55e; /* Green for success */
        --error: #ef4444; /* Red for errors */
        --warning: #f59e0b; /* Orange for warnings */
        --border-color: #e2e8f0; /* Light border */
        --light-blue: rgba(96, 165, 250, 0.2); /* Subtle blue background */
        --radius-sm: 8px;
        --radius-md: 12px;
        --radius-lg: 15px;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes typingDot {
        0%,
        100% {
          transform: translateY(0);
          opacity: 0.6;
        }
        50% {
          transform: translateY(-4px);
          opacity: 1;
        }
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Poppins", sans-serif;
      }

      body {
        background: var(--background);
        min-height: 100vh;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        animation: fadeIn 0.5s ease-out;
      }

      .container {
        max-width: 1200px; /* Increased width to accommodate shortcuts */
        width: 100%;
      }

      .header {
        display: flex;
        align-items: center;
        justify-content: space-between; /* Adjusted for new button */
        margin-bottom: 1.5rem;
        width: 100%;
        max-width: 900px;
        margin-left: auto;
        margin-right: auto;
      }

      .back-button {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--card-bg);
        color: var(--primary-color);
        text-decoration: none;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--shadow);
        transition: all 0.3s ease;
      }

      .back-button:hover {
        background: var(--primary-color);
        color: var(--card-bg);
        transform: scale(1.05);
      }

      .back-button i {
        font-size: 1.2rem;
      }

      .main-content {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        gap: 2rem;
      }

      .flashcard-container {
        position: relative;
        width: 100%;
        max-width: 900px;
        height: 550px;
        perspective: 1000px;
        animation: fadeIn 0.3s ease-out;
      }

      .flashcard {
        position: absolute;
        width: 100%;
        height: 100%;
        transform-style: preserve-3d;
        transition: transform 0.6s ease-in-out;
        cursor: pointer;
        border-radius: var(--radius-md);
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
      }

      .flashcard.flipped {
        transform: rotateY(180deg);
      }

      .card-face {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: var(--card-bg);
        border-radius: var(--radius-md);
        padding: 1.5rem;
        overflow: hidden;
        overflow-wrap: break-word;
        word-break: break-word;
      }

      .card-back {
        transform: rotateY(180deg);
        background: var(--light-blue);
      }

      .shortcuts-info {
        width: 200px;
        padding: 1.5rem;
        background: var(--card-bg);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow);
      }

      .shortcuts-info h3 {
        color: var(--primary-color);
        margin-bottom: 1rem;
        font-size: 1rem;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 0.5rem;
      }

      .shortcuts-info ul {
        list-style: none;
        padding: 0;
      }

      .shortcuts-info li {
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-bottom: 0.75rem;
      }

      .shortcuts-info kbd {
        padding: 0.2rem 0.5rem;
        border-radius: var(--radius-sm);
        background: var(--light-blue);
        color: var(--text-primary);
        font-family: monospace;
        font-weight: 600;
        border: 1px solid var(--border-color);
      }

      .card-word {
        font-size: 2rem;
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 0.75rem;
        text-align: center;
        max-width: 100%;
      }

      .card-phonetic {
        font-size: 1rem;
        color: var(--text-secondary);
        margin-bottom: 0.75rem;
        max-width: 100%;
      }

      .card-image {
        max-width: 280px;
        max-height: 180px;
        object-fit: contain;
        margin-bottom: 1rem;
        border-radius: var(--radius-sm);
      }

      .card-counter {
        position: absolute;
        top: 1rem;
        left: 1rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-secondary);
      }

      .card-controls {
        margin-top: 1.5rem;
        display: flex;
        gap: 0.75rem;
        justify-content: center;
        flex-wrap: wrap;
        padding: 0 1rem;
        width: 100%;
        max-width: 900px;
      }

      .btn {
        padding: 0.7rem 1.5rem;
        border: none;
        border-radius: var(--radius-sm);
        font-weight: 600;
        cursor: pointer;
        background: var(--card-bg);
        color: var(--primary-color);
        box-shadow: var(--shadow);
        transition: all 0.3s ease;
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      }

      .btn-primary {
        background: var(--primary-color);
        color: var(--card-bg);
      }

      .btn-primary:hover {
        background: var(--secondary-color);
      }

      .btn-secondary {
        background: transparent;
        border: 2px solid var(--primary-color);
      }

      .btn-secondary:hover {
        background: var(--primary-color);
        color: var(--card-bg);
      }

      .btn.active {
        background: var(--secondary-color);
        color: var(--card-bg);
      }

      .btn i {
        font-size: 1rem;
        color: inherit;
      }

      .control-btn {
        padding: 0.7rem 1.5rem;
        border: none;
        border-radius: var(--radius-sm);
        font-weight: 600;
        cursor: pointer;
        background: var(--card-bg);
        color: var(--primary-color);
        box-shadow: var(--shadow);
        transition: all 0.3s ease;
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
      }

      .control-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      }

      .control-btn.btn-primary {
        background: var(--primary-color);
        color: var(--card-bg);
      }

      .control-btn.btn-primary:hover {
        background: var(--secondary-color);
      }

      .control-btn.active {
        background: var(--secondary-color);
        color: var(--card-bg);
      }

      .control-btn i {
        font-size: 1rem;
        color: inherit;
      }

      .action-buttons {
        position: absolute;
        top: 1rem;
        right: 1rem;
        display: flex;
        gap: 0.5rem;
      }

      .action-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--card-bg);
        color: var(--primary-color);
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: var(--shadow);
        transition: all 0.3s ease;
      }

      .action-btn:hover {
        background: var(--primary-color);
        color: var(--card-bg);
        transform: scale(1.05);
      }

      .action-btn i {
        font-size: 1rem;
      }

      .action-btn:hover i {
        color: var(--card-bg);
      }

      .action-btn #favoriteIcon.fas {
        color: var(--warning);
      }

      .action-btn:hover #favoriteIcon.fas {
        color: var(--card-bg);
      }

      /* New Options Menu Styles */
      .options-menu {
        display: none;
        position: absolute;
        top: calc(1rem + 40px); /* Position below the options button */
        right: 1rem;
        background-color: var(--card-bg);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow);
        z-index: 1050;
        padding: 0.5rem 0;
        animation: fadeIn 0.2s ease-out;
        list-style: none;
        min-width: 220px;
      }

      .options-menu.active {
        display: block;
      }

      .options-menu-item {
        padding: 0.75rem 1.25rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.9rem;
        color: var(--text-primary);
        background: none;
        border: none;
        width: 100%;
        text-align: left;
      }

      .options-menu-item:hover {
        background-color: var(--light-blue);
      }

      .options-menu-item i {
        color: var(--primary-color);
        width: 20px;
        text-align: center;
      }

      /* Modal Overlay */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(5px);
        z-index: 999;
        animation: fadeIn 0.3s;
      }

      .modal-overlay.active {
        display: block;
      }

      .modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%); /* Centering */
        width: 90%;
        max-width: 500px; /* Max width for larger screens */
        background: var(--card-bg);
        border-radius: var(--radius-md);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        max-height: 85vh;
        overflow-y: auto;
        z-index: 1000;
        animation: fadeIn 0.3s ease-out;
      }

      .modal.active {
        display: flex;
        flex-direction: column;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
      }

      .modal-header h2 {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--primary-color);
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .modal-content {
        padding: 1.5rem;
      }

      .close-btn:hover {
        color: var(--primary-color);
      }

      .close-btn i {
        font-size: 1.5rem;
      }

      .edit-form label {
        display: block;
        font-size: 0.95rem;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
        font-weight: 500;
      }

      .edit-form input,
      .edit-form textarea,
      .edit-form-select {
        width: 100%;
        padding: 0.75rem;
        margin-bottom: 1rem;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-sm);
        font-size: 0.95rem;
        background: var(--card-bg);
        transition: all 0.3s ease;
      }

      .edit-form textarea {
        resize: vertical;
        min-height: 100px;
      }

      .edit-form input:focus,
      .edit-form textarea:focus,
      .edit-form-select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2);
      }

      .edit-form button {
        width: 100%;
      }

      .dict-word {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--primary-color);
      }

      .dict-phonetic {
        color: var(--text-secondary);
        font-size: 0.95rem;
        margin-bottom: 1rem;
      }

      .dict-meaning {
        margin-bottom: 1rem;
      }

      .dict-meaning h3 {
        color: var(--primary-color);
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
      }

      .dict-translation {
        font-size: 0.95rem;
        color: var(--text-primary);
      }

      .dict-example {
        color: var(--text-secondary);
        font-style: italic;
        margin: 0.5rem 0;
        padding-left: 1rem;
        border-left: 2px solid var(--primary-color);
      }

      .syn-ant-content h3 {
        color: var(--primary-color);
        font-size: 1rem;
        margin-bottom: 0.5rem;
      }

      .syn-ant-content ul {
        list-style: none;
        padding: 0;
        margin-bottom: 1rem;
      }

      .syn-ant-content li {
        font-size: 0.95rem;
        color: var(--text-primary);
        margin-bottom: 0.3rem;
      }

      .modal-content .btn-secondary {
        margin-top: 1rem;
        background: var(--card-bg);
        border: 2px solid var(--primary-color);
        color: var(--primary-color);
      }

      .modal-content .btn-secondary:hover {
        background: var(--primary-color);
        color: var(--card-bg);
      }

      .sentence-content strong {
        font-weight: 700;
        color: var(--primary-color);
      }

      .sentence-translation {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin: 1rem 0;
      }

      .progress-bar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: var(--border-color);
        z-index: 2000;
      }

      .progress {
        height: 100%;
        background: var(--primary-color);
        transition: width 0.3s ease;
      }

      /* Chat box styles */
      .unier-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--card-bg);
        color: var(--primary-color);
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: var(--shadow);
        transition: all 0.3s ease;
      }

      .unier-btn:hover {
        background: var(--primary-color);
        color: var(--card-bg);
        transform: scale(1.05);
      }

      .unier-btn i {
        font-size: 1.2rem;
      }

      .unier-chat {
        display: none;
        position: fixed;
        bottom: 1.5rem;
        right: 1.5rem;
        width: 350px;
        background: var(--card-bg);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow);
        padding: 1rem;
        max-height: 70vh;
        overflow-y: auto;
        z-index: 1000;
        animation: slideDown 0.3s ease-out;
      }

      .unier-chat.active {
        display: block;
      }

      .unier-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
      }

      .unier-header img {
        width: 28px;
        height: 28px;
        border-radius: 50%;
      }

      .unier-header h2 {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--primary-color);
      }

      .chat-messages {
        max-height: 50vh;
        overflow-y: auto;
        margin-bottom: 1rem;
        padding: 0.5rem;
      }

      .message-container {
        margin: 0.5rem 0;
      }

      .message {
        max-width: 85%;
        padding: 0.75rem 1rem;
        border-radius: var(--radius-sm);
        font-size: 0.9rem;
        line-height: 1.5;
      }

      .user-message {
        margin-left: auto;
        background: var(--primary-color);
        color: var(--card-bg);
        border-bottom-right-radius: 2px;
      }

      .ai-message {
        margin-right: auto;
        background: var(--light-blue);
        border: 1px solid var(--border-color);
        border-bottom-left-radius: 2px;
      }

      .typing-indicator {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 0.5rem 0.75rem;
        background: var(--light-blue);
        border-radius: var(--radius-sm);
        margin-bottom: 0.5rem;
        width: fit-content;
      }

      .typing-dot {
        width: 6px;
        height: 6px;
        background: var(--primary-color);
        border-radius: 50%;
        opacity: 0.6;
        animation: typingDot 1s infinite;
      }

      .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
      }

      .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
      }

      .chat-input-area {
        display: flex;
        gap: 0.5rem;
      }

      .chat-input {
        flex: 1;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-sm);
        font-size: 0.9rem;
        outline: none;
        resize: none;
        max-height: 100px;
        background: var(--card-bg);
        transition: all 0.3s ease;
      }

      .chat-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2);
      }

      .send-btn {
        padding: 0.7rem 1rem;
      }

      .send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Settings Modal Styles */
      .settings-section {
        margin-bottom: 1.5rem;
      }
      .settings-section label,
      .settings-section h3 {
        display: block;
        font-size: 1rem;
        color: var(--text-primary);
        margin-bottom: 0.75rem;
        font-weight: 600;
      }
      .shortcuts-list {
        list-style: none;
        padding: 0;
      }
      .shortcuts-list li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--border-color);
      }
      .shortcuts-list li:last-child {
        border-bottom: none;
      }
      .shortcuts-list span {
        font-size: 0.95rem;
      }
      .keybind-display {
        padding: 0.2rem 0.6rem;
        border-radius: var(--radius-sm);
        background: var(--light-blue);
        color: var(--text-primary);
        font-family: monospace;
        font-weight: 600;
        border: 1px solid var(--border-color);
        min-width: 50px;
        text-align: center;
      }
      .keybind-display.rebinding {
        color: var(--primary-color);
        font-style: italic;
      }
      .btn-change-key {
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
        border-radius: var(--radius-sm);
        border: 1px solid var(--primary-color);
        background: transparent;
        color: var(--primary-color);
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .btn-change-key:hover {
        background: var(--primary-color);
        color: var(--card-bg);
      }

      @media (max-width: 1200px) {
        .shortcuts-info {
          display: none; /* Hide shortcuts on smaller screens */
        }
        .container {
          max-width: 1000px;
        }
      }

      @media (max-width: 768px) {
        body {
          padding: 1rem;
        }

        .main-content {
          flex-direction: column;
          align-items: center;
        }

        .flashcard-container {
          max-width: 600px;
          height: 500px;
        }

        .card-word {
          font-size: 1.75rem;
        }

        .card-phonetic {
          font-size: 0.9rem;
        }

        .card-image {
          max-width: 250px;
          max-height: 150px;
        }

        .btn,
        .control-btn {
          padding: 0.65rem 1rem;
          font-size: 0.9rem;
        }

        .action-btn {
          width: 32px;
          height: 32px;
        }

        .action-btn i {
          font-size: 0.9rem;
        }

        .modal {
          width: 90%;
          max-width: 90%;
          padding: 0;
        }

        .modal-header {
          padding: 1rem;
        }

        .modal-content {
          padding: 1rem;
        }

        .unier-chat {
          width: 90%;
          right: 5%;
          bottom: 1.5rem;
        }
      }

      @media (max-width: 480px) {
        .flashcard-container {
          height: 450px;
        }

        .card-word {
          font-size: 1.5rem;
        }

        .card-phonetic {
          font-size: 0.85rem;
        }

        .card-image {
          max-width: 200px;
          max-height: 120px;
        }

        .modal-header h2 {
          font-size: 1.1rem;
        }

        .edit-form input,
        .edit-form textarea {
          padding: 0.65rem;
          font-size: 0.9rem;
        }

        .action-btn {
          width: 30px;
          height: 30px;
        }

        .action-btn i {
          font-size: 0.85rem;
        }

        .btn,
        .control-btn {
          padding: 0.6rem 0.8rem;
          font-size: 0.85rem;
        }

        .control-btn i {
          font-size: 0.9rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="progress-bar">
      <div class="progress" id="progress"></div>
    </div>

    <div class="modal-overlay" id="modalOverlay"></div>

    <div class="container">
      <div class="header">
        <a href="#" class="back-button" id="backButton">
          <i class="fas fa-arrow-left"></i>
        </a>
        <button class="unier-btn" onclick="toggleUnierChat()">
          <i class="fas fa-chalkboard-teacher"></i>
        </button>
      </div>

      <div class="main-content">
        <div class="flashcard-container">
          <div class="flashcard" onclick="flipCard(this)">
            <div class="card-face card-front"></div>
            <div class="card-face card-back"></div>
          </div>

          <ul class="options-menu" id="optionsMenu">
            <li>
              <button
                class="options-menu-item"
                onclick="openModal(event, 'dictionaryModal')"
              >
                <i class="fas fa-book"></i> Từ điển
              </button>
            </li>
            <li>
              <button
                class="options-menu-item"
                onclick="openModal(event, 'editModal')"
              >
                <i class="fas fa-edit"></i> Sửa thẻ
              </button>
            </li>
            <li>
              <button
                class="options-menu-item"
                onclick="openModal(event, 'sentenceModal')"
              >
                <i class="fas fa-comment-dots"></i> Tạo câu ví dụ
              </button>
            </li>
            <li>
              <button
                class="options-menu-item"
                onclick="openModal(event, 'synAntModal')"
              >
                <i class="fas fa-exchange-alt"></i> Đồng nghĩa & Trái nghĩa
              </button>
            </li>
             <li>
              <button
                class="options-menu-item"
                onclick="openModal(event, 'settingsModal')"
              >
                <i class="fas fa-sliders-h"></i> Cài đặt
              </button>
            </li>
          </ul>
        </div>

        <div class="shortcuts-info">
          <h3>Phím tắt</h3>
          <ul id="shortcutsInfoList">
            </ul>
        </div>
      </div>

      <div class="card-controls">
        <button class="control-btn" onclick="previousCard()">
          <i class="fas fa-chevron-left"></i> Trước
        </button>
        <button class="control-btn" onclick="randomCard()">
          <i class="fas fa-random"></i> Ngẫu nhiên
        </button>
        <button class="control-btn" onclick="toggleAutoPlay()">
          <i class="fas fa-play" id="autoPlayIcon"></i> Tự động
        </button>
        <button class="control-btn btn-primary" onclick="nextCard()">
          Tiếp <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>

    <div class="modal" id="dictionaryModal">
      <div class="modal-header">
        <h2>Từ điển</h2>
        <button class="close-btn" onclick="closeAllModals(event)">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-content" id="dictionaryContent"></div>
    </div>

    <div class="modal" id="editModal">
      <div class="modal-header">
        <h2>Sửa Flashcard</h2>
        <button class="close-btn" onclick="closeAllModals(event)">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-content">
        <form class="edit-form" onsubmit="saveEdit(event)">
          <label for="editWord">Từ vựng:</label>
          <input type="text" id="editWord" required />
          <label for="editIPA">Phiên âm (IPA):</label>
          <input type="text" id="editIPA" />
          <label for="editMeaning">Nghĩa:</label>
          <textarea id="editMeaning" required></textarea>
          <label for="editImage">URL hình ảnh (nếu có):</label>
          <input type="url" id="editImage" />
          <button class="btn btn-primary" type="submit">Lưu thay đổi</button>
        </form>
      </div>
    </div>

    <div class="modal" id="sentenceModal">
      <div class="modal-header">
        <h2>Câu Ví Dụ</h2>
        <button class="close-btn" onclick="closeAllModals(event)">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-content">
        <div class="sentence-content" id="sentenceContent"></div>
        <div class="sentence-translation" id="sentenceTranslation"></div>
        <button
          class="btn btn-secondary"
          onclick="generateSentence(event, false)"
        >
          <i class="fas fa-sync-alt"></i> Xem Câu Khác
        </button>
      </div>
    </div>

    <div class="modal" id="synAntModal">
      <div class="modal-header">
        <h2>Từ Đồng Nghĩa & Trái Nghĩa</h2>
        <button class="close-btn" onclick="closeAllModals(event)">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-content" id="synAntContent"></div>
    </div>
    
    <div class="modal" id="settingsModal">
      <div class="modal-header">
        <h2>Cài đặt</h2>
        <button class="close-btn" onclick="closeAllModals(event)">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-content">
        <div class="settings-section">
            <label for="voiceSelect">Giọng đọc:</label>
            <select id="voiceSelect" class="edit-form-select"></select>
        </div>
        <div class="settings-section">
            <h3>Phím tắt</h3>
            <ul class="shortcuts-list" id="shortcutsList">
                </ul>
        </div>
      </div>
    </div>

    <div class="unier-chat" id="unierChat">
      <div class="unier-header">
        <img src="https://via.placeholder.com/32" alt="UNIer Avatar" />
        <h2>UNIer</h2>
      </div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input-area">
        <textarea
          class="chat-input"
          id="chatInput"
          placeholder="Hỏi UNIer..."
          rows="1"
          onkeydown="if(event.key === 'Enter' && !event.shiftKey) {event.preventDefault(); sendChatMessage();}"
        ></textarea>
        <button class="send-btn" onclick="sendChatMessage()">Gửi</button>
      </div>
    </div>

   <script>
    // *** TÍCH HỢP FIREBASE VÀ TOÀN BỘ LOGIC ***
    const firebaseScripts = [
        "https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js",
        "https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js",
        "https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"
    ];
    let scriptLoadedCount = 0;
    firebaseScripts.forEach(src => {
        const script = document.createElement('script');
        script.src = src;
        script.async = false;
        script.onload = () => {
            scriptLoadedCount++;
            if (scriptLoadedCount === firebaseScripts.length) {
                initializeApp();
            }
        };
        document.head.appendChild(script);
    });

    let db, auth, currentUser, currentFolderId;

    function initializeApp() {
        const firebaseConfig = {
            apiKey: "AIzaSyAm-p5xIzMi7Rkt6y9TzODJLFjdpLKBIlg",
            authDomain: "wordwhizzy.firebaseapp.com",
            projectId: "wordwhizzy",
            storageBucket: "wordwhizzy.appspot.com",
            messagingSenderId: "179575783469",
            appId: "1:179575783469:web:30d0ae652af3cfda4bb8a4",
            measurementId: "G-XPFQ8PCTRE"
        };
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        db = firebase.firestore();
        auth = firebase.auth();

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                systemPrompt.content = systemPrompt.content.replace(/👤 Người dùng: \w+/, `👤 Người dùng: ${user.displayName || 'bạn'}`);
                currentContext.userId = user.uid;
                main();
            } else {
                window.location.href = 'login.html';
            }
        });
    }

    // --- Các biến và DOM Elements ---
    let currentIndex = 0;
    let allFlashcards = []; // Master list from Firestore
    let flashcards = []; // Displayed list (only favorited cards)
    let autoPlayInterval = null;
    const API_URL = "https://api-alpha-six-99.vercel.app/api/chat/";
    const CURRENT_TIME = new Date().toISOString();
    const modalOverlay = document.getElementById("modalOverlay");
    const optionsMenu = document.getElementById("optionsMenu");
    const allModals = document.querySelectorAll(".modal");
    const voiceSelect = document.getElementById("voiceSelect");
    let voices = [];
    let userSettings = {};
    let keybindings = {};
    const defaultKeybindings = { flip: " ", next: "ArrowRight", prev: "ArrowLeft", audio: "Control" };

    // --- Logic chính của trang ---
    async function main() {
        loadUserSettings();
        const urlParams = new URLSearchParams(window.location.search);
        currentFolderId = urlParams.get("id");

        if (!currentFolderId) {
            alert("Không tìm thấy thông tin thư mục!");
            window.location.href = "vocabulary.html";
            return;
        }

        document.getElementById("backButton").href = `flashcards.html?id=${currentFolderId}`;

        // Tải dữ liệu từ Firestore
        const flashcardsRef = db.collection('users').doc(currentUser.uid).collection('flashcards').doc(currentFolderId);
        const doc = await flashcardsRef.get();

        if (doc.exists) {
            allFlashcards = doc.data().words || [];
            // FILTER FOR FAVORITES - This is the key change for this file
            flashcards = allFlashcards.filter(card => card.favorite === true);
            
            if (flashcards.length > 0) {
              showCard(0);
            } else {
               document.querySelector(".card-front").innerHTML = `<div class="card-word">Không có từ nào được lưu để ôn tập.<br/><small>Hãy quay lại và đánh dấu sao ⭐️ những từ bạn muốn ôn nhé.</small></div>`;
               document.querySelector(".card-back").innerHTML = "";
               document.getElementById("progress").style.width = '0%';
               // Disable controls if no cards
                document.querySelectorAll('.control-btn, .action-btn').forEach(btn => btn.disabled = true);
            }
            updateProgress();
            initializeUnierChat();
            populateVoiceList();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = populateVoiceList;
            }
        } else {
            alert("Không tìm thấy dữ liệu bộ thẻ.");
            window.location.href = `vocabulary-input.html?id=${currentFolderId}`;
        }

        // Gắn các event listener
        modalOverlay.addEventListener("click", closeAllModals);
        voiceSelect.addEventListener("change", handleVoiceChange);
        document.addEventListener("keydown", handleGlobalKeyDown);
        document.getElementById("chatInput").addEventListener("input", function() {
            this.style.height = "auto";
            this.style.height = Math.min(this.scrollHeight, 100) + "px";
        });
        document.addEventListener("click", (e) => {
            const unierChat = document.getElementById("unierChat");
            if (unierChat.classList.contains("active") && !unierChat.contains(e.target) && !e.target.closest(".unier-btn")) {
                unierChat.classList.remove("active");
            }
            if (!optionsMenu.contains(e.target) && !e.target.closest(".action-btn[onclick='toggleOptionsMenu(event)']")) {
                optionsMenu.classList.remove("active");
            }
        });
        let touchStartX = 0;
        document.querySelector(".flashcard").addEventListener("touchstart", (e) => {
            touchStartX = e.changedTouches[0].screenX;
        });
        document.querySelector(".flashcard").addEventListener("touchend", (e) => {
            const touchEndX = e.changedTouches[0].screenX;
            if (touchEndX - touchStartX > 50) previousCard();
            else if (touchStartX - touchEndX > 50) nextCard();
        });
    }

    // --- Các hàm lưu trữ dữ liệu ---
    async function saveAllFlashcardsToFirestore() {
        if (!currentUser || !currentFolderId) return;
        const flashcardsRef = db.collection('users').doc(currentUser.uid).collection('flashcards').doc(currentFolderId);
        try {
            // Save the entire master list back to Firestore
            await flashcardsRef.set({ words: allFlashcards });
        } catch (error) {
            console.error("Lỗi khi lưu vào Firestore:", error);
            alert("Đã có lỗi xảy ra khi lưu thay đổi.");
        }
    }

    async function toggleFavorite(event) {
        event.stopPropagation();
        
        // Find the original card in the master list and toggle its favorite status
        const currentCard = flashcards[currentIndex];
        const originalCardIndex = allFlashcards.findIndex(card => card.word === currentCard.word && card.meaning === currentCard.meaning);
        
        if(originalCardIndex !== -1) {
            allFlashcards[originalCardIndex].favorite = !allFlashcards[originalCardIndex].favorite;
            await saveAllFlashcardsToFirestore();

            // Remove the card from the current review session
            flashcards.splice(currentIndex, 1);

            // Adjust index and show the next card
            if (currentIndex >= flashcards.length) {
                currentIndex = 0; // Go to the beginning if it was the last card
            }

            if (flashcards.length > 0) {
                showCard(currentIndex);
            } else {
                // Handle case where the last favorited card is removed
                main(); // Re-run main to show the "no cards" message
            }
        }
    }

    async function saveEdit(event) {
        event.preventDefault();
        const word = document.getElementById("editWord").value;
        const ipa = document.getElementById("editIPA").value;
        const meaning = document.getElementById("editMeaning").value;
        const image = document.getElementById("editImage").value;

        const currentCard = flashcards[currentIndex];
        const originalCardIndex = allFlashcards.findIndex(card => card.word === currentCard.word && card.meaning === currentCard.meaning);

        if(originalCardIndex !== -1) {
            const updatedCard = { ...allFlashcards[originalCardIndex], word, ipa, meaning, image: image || allFlashcards[originalCardIndex].image };
            allFlashcards[originalCardIndex] = updatedCard; // Update master list
            flashcards[currentIndex] = updatedCard; // Update current view list
            await saveAllFlashcardsToFirestore();
            showCard(currentIndex);
            closeAllModals();
        }
    }

    // --- Các hàm cài đặt và phím tắt ---
    function loadUserSettings() {
        const savedSettings = JSON.parse(localStorage.getItem("userFlashcardSettings"));
        if (savedSettings) {
            userSettings = savedSettings;
            keybindings = savedSettings.keybindings || { ...defaultKeybindings };
        } else {
            userSettings = { voiceURI: null, keybindings: { ...defaultKeybindings } };
            keybindings = { ...defaultKeybindings };
        }
        updateShortcutsInfo();
    }

    function saveUserSettings() {
        userSettings.keybindings = keybindings;
        localStorage.setItem("userFlashcardSettings", JSON.stringify(userSettings));
        updateShortcutsInfo();
    }

    function populateVoiceList() {
        voices = speechSynthesis.getVoices();
        voiceSelect.innerHTML = "";
        const savedVoiceURI = userSettings.voiceURI;
        voices.forEach((voice) => {
            if (voice.lang.startsWith("en")) {
                const option = document.createElement("option");
                option.textContent = `${voice.name} (${voice.lang})`;
                option.setAttribute("data-voice-uri", voice.voiceURI);
                option.setAttribute("data-lang", voice.lang);
                voiceSelect.appendChild(option);
                if (voice.voiceURI === savedVoiceURI) {
                    option.selected = true;
                }
            }
        });
    }

    function displayKeybindings() {
        const keyMap = { flip: "Lật thẻ", next: "Thẻ tiếp", prev: "Thẻ trước", audio: "Nghe" };
        const list = document.getElementById("shortcutsList");
        list.innerHTML = "";
        for (const action in keybindings) {
            const li = document.createElement("li");
            li.innerHTML = `<span>${keyMap[action]}:</span><div><kbd class="keybind-display">${keybindings[action] === " " ? "Space" : keybindings[action]}</kbd><button class="btn-change-key" data-action="${action}">Đổi</button></div>`;
            list.appendChild(li);
        }
        document.querySelectorAll(".btn-change-key").forEach((button) => {
            button.addEventListener("click", beginRebind);
        });
    }

    function beginRebind(e) {
        const action = e.target.dataset.action;
        const display = e.target.parentElement.querySelector('.keybind-display');
        display.textContent = "Chờ phím...";
        display.classList.add("rebinding");

        const handleNewKey = (event) => {
            event.preventDefault();
            event.stopPropagation();
            const newKey = event.key;
            const existingAction = Object.keys(keybindings).find(k => keybindings[k] === newKey);
            if (existingAction && existingAction !== action) {
                alert(`Phím "${newKey}" đã được gán cho hành động khác. Vui lòng chọn phím khác.`);
                displayKeybindings();
                document.removeEventListener("keydown", handleNewKey, true);
                return;
            }
            keybindings[action] = newKey;
            saveUserSettings();
            displayKeybindings();
            document.removeEventListener("keydown", handleNewKey, true);
        };
        document.addEventListener("keydown", handleNewKey, { capture: true });
    }

    function updateShortcutsInfo() {
        const keyMap = { flip: "Lật thẻ", next: "Thẻ tiếp", prev: "Thẻ trước", audio: "Nghe" };
        const keyDisplayMap = { " ": "Space", "ArrowRight": "→", "ArrowLeft": "←", };
        const list = document.getElementById('shortcutsInfoList');
        if (!list) return;
        list.innerHTML = "";
        for (const action in keybindings) {
            const li = document.createElement("li");
            const key = keybindings[action];
            const displayKey = keyDisplayMap[key] || key;
            li.innerHTML = `<span>${keyMap[action]}</span> <kbd>${displayKey}</kbd>`;
            list.appendChild(li);
        }
    }

    // --- Các hàm xử lý sự kiện ---
    function handleVoiceChange(e) {
        const selectedOption = e.target.options[e.target.selectedIndex];
        const voiceURI = selectedOption.getAttribute("data-voice-uri");
        const lang = selectedOption.getAttribute("data-lang");
        userSettings.voiceURI = voiceURI;
        saveUserSettings();
        const utterance = new SpeechSynthesisUtterance("This is the selected voice.");
        const selectedVoice = voices.find((v) => v.voiceURI === voiceURI);
        if (selectedVoice) {
            utterance.voice = selectedVoice;
            utterance.lang = lang;
            speechSynthesis.cancel();
            speechSynthesis.speak(utterance);
        }
    }

    function handleGlobalKeyDown(event) {
        const activeElement = document.activeElement;
        const isInputFocused = activeElement.tagName === "INPUT" || activeElement.tagName === "TEXTAREA" || activeElement.classList.contains('rebinding');
        const isModalActive = document.querySelector(".modal.active");

        if (isInputFocused && activeElement.id !== 'chatInput') return;
        if (event.key === "Escape" && isModalActive) { closeAllModals(); }
        if (isModalActive && !activeElement.classList.contains('rebinding')) return;

        const action = Object.keys(keybindings).find(k => keybindings[k] === event.key);
        if (!action) return;

        event.preventDefault();
        switch (action) {
            case "flip":
                const flashcardElement = document.querySelector(".flashcard");
                if (flashcardElement) flipCard(flashcardElement);
                break;
            case "next": nextCard(); break;
            case "prev": previousCard(); break;
            case "audio": playAudio({ stopPropagation: () => {} }); break;
        }
    }

    // --- Logic hiển thị và điều khiển Flashcard ---
    function showCard(index) {
        if (flashcards.length === 0) return;
        currentIndex = index;
        const card = flashcards[index];
        const frontSide = document.querySelector(".card-front");
        const backSide = document.querySelector(".card-back");

        frontSide.innerHTML = `<span class="card-counter">${currentIndex + 1}/${flashcards.length}</span>
          <div class="action-buttons">
            <button class="action-btn" onclick="playAudio(event)"><i class="fas fa-volume-up"></i></button>
            <button class="action-btn" onclick="toggleFavorite(event)"><i class="${card.favorite ? "fas" : "far"} fa-star" id="favoriteIcon"></i></button>
            <button class="action-btn" onclick="toggleOptionsMenu(event)"><i class="fas fa-ellipsis-h"></i></button>
          </div>
          ${card.image ? `<img src="${card.image}" class="card-image" alt="${card.word}">` : ""}
          <div class="card-word">${card.word}</div>
          <div class="card-phonetic">${card.ipa || ""}</div>`;

        backSide.innerHTML = `<div class="card-word">${card.meaning}</div>`;
        updateProgress();
        closeAllModals();
        document.querySelector(".flashcard").classList.remove("flipped");
    }

    function updateProgress() {
        if (flashcards.length === 0) return;
        const progress = document.getElementById("progress");
        const percentage = ((currentIndex + 1) / flashcards.length) * 100;
        progress.style.width = `${percentage}%`;
    }

    function flipCard(element) {
        if (!document.querySelector(".modal.active") && !optionsMenu.classList.contains("active")) {
            element.classList.toggle("flipped");
        }
    }

    function nextCard() {
        if (flashcards.length === 0) return;
        if (currentIndex < flashcards.length - 1) {
            currentIndex++;
        } else {
            currentIndex = 0; // Quay về thẻ đầu tiên
        }
        showCard(currentIndex);
    }

    function previousCard() {
        if (flashcards.length === 0) return;
        if (currentIndex > 0) {
            currentIndex--;
        } else {
            currentIndex = flashcards.length - 1; // Về thẻ cuối cùng
        }
        showCard(currentIndex);
    }

    function randomCard() {
        if (flashcards.length <= 1) return;
        const newIndex = Math.floor(Math.random() * flashcards.length);
        currentIndex = newIndex;
        showCard(currentIndex);
    }

    function toggleAutoPlay() {
        const btn = document.querySelector(".control-btn[onclick='toggleAutoPlay()']");
        const icon = document.getElementById("autoPlayIcon");
        if (autoPlayInterval) {
            clearInterval(autoPlayInterval);
            autoPlayInterval = null;
            btn.classList.remove("active");
            icon.classList.remove("fa-pause"); icon.classList.add("fa-play");
        } else {
            autoPlayInterval = setInterval(() => { nextCard(); }, 3000);
            btn.classList.add("active");
            icon.classList.remove("fa-play"); icon.classList.add("fa-pause");
        }
    }

    function playAudio(event) {
        event.stopPropagation();
        if (flashcards.length === 0) return;
        const utterance = new SpeechSynthesisUtterance(flashcards[currentIndex].word);
        const selectedVoice = voices.find((v) => v.voiceURI === userSettings.voiceURI);
        if (selectedVoice) {
            utterance.voice = selectedVoice;
            utterance.lang = selectedVoice.lang;
        } else {
            utterance.lang = "en-US";
        }
        speechSynthesis.speak(utterance);
    }

    // --- Các hàm Modal và API ---
    function toggleOptionsMenu(event) {
        event.stopPropagation();
        optionsMenu.classList.toggle("active");
    }

    function closeAllModals(event) {
        if (event) event.stopPropagation();
        modalOverlay.classList.remove("active");
        allModals.forEach((modal) => modal.classList.remove("active"));
        optionsMenu.classList.remove("active");
    }

    async function openModal(event, modalId) {
        event.stopPropagation();
        closeAllModals();

        if (flashcards.length === 0) {
            alert("Không có thẻ nào để thực hiện hành động này.");
            return;
        }

        const modal = document.getElementById(modalId);
        if (!modal) return;
        modalOverlay.classList.add("active");
        modal.classList.add("active");

        const card = flashcards[currentIndex];
        switch (modalId) {
            case "dictionaryModal": await searchDictionary(); break;
            case "editModal":
                document.getElementById("editWord").value = card.word;
                document.getElementById("editIPA").value = card.ipa || "";
                document.getElementById("editMeaning").value = card.meaning;
                document.getElementById("editImage").value = card.image || "";
                break;
            case "sentenceModal": await generateSentence(event, true); break;
            case "synAntModal": await fetchSynonymsAntonyms(); break;
            case "settingsModal": populateVoiceList(); displayKeybindings(); break;
        }
    }

    async function searchDictionary() {
        const word = flashcards[currentIndex].word;
        const dictionaryContent = document.getElementById("dictionaryContent");
        dictionaryContent.innerHTML = "<div>Đang tìm kiếm...</div>";
        try {
            const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
            const data = await response.json();
            if (Array.isArray(data)) {
                const entry = data[0];
                const phonetic = entry.phonetic || flashcards[currentIndex].ipa || "";
                let html = `<div class="dict-word">${word}</div><div class="dict-phonetic">${phonetic}</div>`;
                entry.meanings.forEach((meaning) => {
                    html += `<div class="dict-meaning"><h3>${meaning.partOfSpeech}</h3><div class="dict-translation">${meaning.definitions[0].definition}</div>${meaning.definitions[0].example ? `<div class="dict-example">${meaning.definitions[0].example}</div>` : ""}</div>`;
                });
                const vietnameseMeaning = flashcards[currentIndex].meaning || "Không có nghĩa tiếng Việt";
                html += `<div class="dict-meaning"><h3>Tiếng Việt</h3><div class="dict-translation">${vietnameseMeaning}</div></div>`;
                dictionaryContent.innerHTML = html;
            } else { dictionaryContent.innerHTML = `<div>Không tìm thấy từ "${word}" trong từ điển.</div>`; }
        } catch (error) { dictionaryContent.innerHTML = `<div>Đã xảy ra lỗi khi tra từ điển.</div>`; console.error(error); }
    }

    async function fetchSynonymsAntonyms() {
        const word = flashcards[currentIndex].word;
        const synAntContent = document.getElementById("synAntContent");
        synAntContent.innerHTML = "<div>Đang tìm kiếm...</div>";
        try {
            const synResponse = await fetch(API_URL, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ model: "gpt-3.5-turbo", messages: [{ role: "user", content: `Provide a list of up to 5 synonyms for the English word "${word}" in a simple format.` }], max_tokens: 100 }) });
            const synData = await synResponse.json();
            const synonyms = synData.choices[0].message.content.split("\n").filter((s) => s.trim()).slice(0, 5);
            const antResponse = await fetch(API_URL, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ model: "gpt-3.5-turbo", messages: [{ role: "user", content: `Provide a list of up to 5 antonyms for the English word "${word}" in a simple format. If no antonyms exist, return "No antonyms found".` }], max_tokens: 100 }) });
            const antData = await antResponse.json();
            const antonyms = antData.choices[0].message.content.split("\n").filter((s) => s.trim()).slice(0, 5);
            let html = `<h3>Từ Đồng Nghĩa</h3><ul>${synonyms.length > 0 ? synonyms.map((syn) => `<li>${syn}</li>`).join("") : "<li>Không tìm thấy</li>"}</ul><h3>Từ Trái Nghĩa</h3><ul>${antonyms.length > 0 && antonyms[0] !== "No antonyms found" ? antonyms.map((ant) => `<li>${ant}</li>`).join("") : "<li>Không tìm thấy</li>"}</ul>`;
            synAntContent.innerHTML = html;
        } catch (error) { synAntContent.innerHTML = `<div>Đã xảy ra lỗi khi tìm kiếm.</div>`; console.error(error); }
    }

    async function generateSentence(event, isFirstLoad = false) {
        if (event) event.stopPropagation();
        const word = flashcards[currentIndex].word;
        const sentenceContent = document.getElementById("sentenceContent");
        const sentenceTranslation = document.getElementById("sentenceTranslation");

        if (isFirstLoad) {
            sentenceContent.innerHTML = "Nhấn nút 'Xem câu khác' để bắt đầu...";
            sentenceTranslation.innerHTML = "";
            return;
        }
        sentenceContent.innerHTML = "Đang tạo câu...";
        sentenceTranslation.innerHTML = "";
        try {
            const sentenceResponse = await fetch(API_URL, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ model: "gpt-3.5-turbo", messages: [{ role: "user", content: `Create a short, simple English sentence using "${word}".` }], max_tokens: 30 }) });
            const sentenceData = await sentenceResponse.json();
            const sentence = sentenceData.choices[0].message.content.trim();
            const highlightedSentence = sentence.replace(new RegExp(`\\b${word}\\b`, "gi"), `<strong>${word}</strong>`);
            sentenceContent.innerHTML = highlightedSentence;
            const translationResponse = await fetch(API_URL, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ model: "gpt-3.5-turbo", messages: [{ role: "user", content: `Translate to Vietnamese: "${sentence}"` }], max_tokens: 30 }) });
            const translationData = await translationResponse.json();
            const translation = translationData.choices[0].message.content.trim();
            sentenceTranslation.innerHTML = `Nghĩa: ${translation}`;
        } catch (error) { sentenceContent.innerHTML = "Lỗi khi tạo câu!"; sentenceTranslation.innerHTML = ""; console.error("Lỗi:", error); }
    }

    // --- UNIer Chat Logic ---
    let systemPrompt = { role: "system", content: `Bạn là UNIer – trợ lý học tiếng Anh **vui tính, lém lỉnh, lầy nhẹ nhưng thông minh cực đỉnh**, được phát triển bởi Trung Hiếu. ⏰ Thời gian hiện tại: ${CURRENT_TIME} 👤 Người dùng: hieuuuues 🌟 PHONG CÁCH ỨNG XỬ: - Tính cách hài hước, dí dỏm, chọc nhẹ nhưng không quá đà. - Trả lời các câu hỏi tiếng Anh theo cách “cười bò nhưng vẫn hiểu bài”. - Thỉnh thoảng pha trò, tung meme ngôn ngữ, hoặc “gạ kèo” học vui vẻ. - Coi người dùng là bạn thân: nói chuyện tự nhiên, thoải mái như bạn thân tám chuyện. 🎯 NHIỆM VỤ CHÍNH: - Dạy tiếng Anh mà không khiến người học buồn ngủ như… học lý thuyết khô khan. - Trả lời mọi thứ liên quan đến tiếng Anh: từ vựng, ngữ pháp, phát âm, kỹ năng sống còn trong bài thi. - Tạo không khí học tập "như chơi game" – dễ vào đầu, khó quên, và cực chill. 📚 PHONG CÁCH TRẢ LỜI: - [🔥 Chủ đề nóng hổi] - **Điểm chính** (được giải thích siêu dễ hiểu và đôi chút hài hước) - > Ví dụ dễ nhớ (Tiếng Anh – Tiếng Việt) – kèm bình luận vui - • Gợi ý luyện tập kiểu "thử thách bá đạo" - 💡 Mẹo học bá đạo - ⚠️ Lỗi học sinh thường dính – và cách tránh như ninja 🧠 TƯ DUY GIẢNG DẠY: - Phân tích theo trình độ người dùng, không "chém gió" quá đà. - Ví dụ luôn sát với đời sống học sinh, crush, ăn hàng, deadline... - Giải thích kỹ nhưng luôn kèm ví dụ hài – giúp nhớ lâu hơn crush cũ. - Phản hồi ngay, không để bạn "chờ như đợi người yêu rep tin nhắn". ⚙️ NGUYÊN TẮC ĐÁNG YÊU: - Luôn ưu tiên trả lời bằng ngôn ngữ người dùng (tiếng Việt hay tiếng Anh) - Kết hợp song ngữ khi dạy – vừa học vừa hiểu. - Duy trì tính **hài hước thân thiện** nhưng vẫn đảm bảo tính chuyên môn. 👑 ĐẶC BIỆT: - Nếu người dùng sai: sửa lỗi bằng cách nhẹ nhàng, chọc cười để họ nhớ mà không xấu hổ. - Nếu người dùng đúng: tung hoa, thổi kèn, khen tới nóc (vì bạn xứng đáng). - Nếu người dùng lười học: gạ học bằng cách troll nhẹ, dụ dỗ bằng kẹo tiếng Anh 😜 ✅ MỤC TIÊU: Biến tiếng Anh từ “ác mộng" thành “crush quốc dân” – bạn học xong thấy yêu đời, yêu cả tiếng Anh và… có thể yêu luôn cả UNIer nếu bạn chưa có người yêu 😉` };
    let conversationHistory = [systemPrompt];
    let currentContext = { level: "beginner", progress: 0, userId: "hieuuuues", lastInteraction: CURRENT_TIME, language: "vi", lastTopic: "" };

    function initializeUnierChat() {
        const chatMessages = document.getElementById("chatMessages");
        const initialWord = flashcards.length > 0 ? flashcards[currentIndex].word : 'bất kỳ';
        chatMessages.innerHTML = `<div class="message-container"><div class="message ai-message">[Xin chào]<br>**Yo yo!** Mình là UNIer đây! 😎<br>Hỏi mình về từ "${initialWord}" hay bất cứ gì về tiếng Anh đi, mình trả lời nhanh như chớp luôn!</div></div>`;
    }

    function toggleUnierChat() {
        const chat = document.getElementById("unierChat");
        chat.classList.toggle("active");
        if (chat.classList.contains("active")) { document.getElementById("chatInput").focus(); }
    }

    function showTypingIndicator() {
        const chatMessages = document.getElementById("chatMessages");
        const typingIndicator = document.createElement("div");
        typingIndicator.className = "typing-indicator";
        typingIndicator.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
        chatMessages.appendChild(typingIndicator);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function removeTypingIndicator() {
        document.querySelector('.typing-indicator')?.remove();
    }

    function appendMessage(content, isUser = false) {
        const chatMessages = document.getElementById("chatMessages");
        const messageContainer = document.createElement("div");
        messageContainer.className = "message-container";
        const message = document.createElement("div");
        message.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
        message.innerHTML = content;
        messageContainer.appendChild(message);
        chatMessages.appendChild(messageContainer);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function detectLanguage(text) {
        return franc(text);
    }

    async function getBotResponse(message) {
        currentContext.lastInteraction = new Date().toISOString();
        currentContext.lastTopic = message;
        currentContext.language = detectLanguage(message) === 'vie' ? 'vi' : 'en';

        const enrichedMessage = {
            role: "user",
            content: `CONTEXT: ${JSON.stringify(currentContext)}\n\nUSER_MESSAGE: ${message}`,
        };
        conversationHistory.push(enrichedMessage);
        
        try {
            const response = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    model: "gpt-4-turbo",
                    messages: conversationHistory,
                    temperature: 0.7,
                }),
            });
            if (!response.ok) throw new Error("API response was not ok.");
            const data = await response.json();
            const botMessage = data.choices[0].message.content;
            conversationHistory.push({ role: "assistant", content: botMessage });
            return botMessage;
        } catch (error) {
            console.error("Error fetching bot response:", error);
            return "Oops, có vẻ như UNIer đang bận pha trà sữa... Bạn thử lại sau nhé!";
        }
    }

    async function sendChatMessage() {
        const chatInput = document.getElementById("chatInput");
        const sendBtn = document.querySelector(".send-btn");
        const message = chatInput.value.trim();
        if (!message) return;

        appendMessage(message, true);
        chatInput.value = "";
        chatInput.style.height = 'auto';
        sendBtn.disabled = true;
        showTypingIndicator();

        const botResponse = await getBotResponse(message);

        removeTypingIndicator();
        appendMessage(botResponse);
        sendBtn.disabled = false;
    }
</script>
  </body>
</html>