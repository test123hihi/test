<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WordWhizzy - Chat AI (v3.1 - Fixed)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            /* Design System updated to Blue Theme */
            --bg: #ffffff;
            --bg-soft: #f9f9f9;
            --text: #1f2937; /* Dark Gray-Blue from trangchu */
            --text-muted: #6B7280; /* Cool Gray from trangchu */
            --border: #e8e8e8;
            --radius: 14px;
            --shadow: 0 8px 24px rgba(59, 130, 246, 0.1); /* Blueish Shadow from trangchu */
            --accent: #3B82F6; /* Primary Blue from trangchu */
            --header-height: 72px;

            /* Chat-specific colors adapted to the new blue system */
            --user-message-bg: var(--accent);
            --user-message-text: #ffffff;
            --ai-message-bg: #f0f0f0;
            --input-border-focus: var(--accent);
            --typing-dot-color: #757575;
            --highlight-color: var(--accent);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Inter", sans-serif; }
        body { background: var(--bg-soft); color: var(--text); line-height: 1.6; padding-top: var(--header-height); }
        
        /* --- Header Styles --- */
        header.app-header { position: fixed; left: 0; right: 0; top: 0; height: var(--header-height); display: flex; align-items: center; justify-content: space-between; padding: 0 24px; background: rgba(255, 255, 255, 0.8); border-bottom: 1px solid var(--border); z-index: 1200; backdrop-filter: blur(8px); }
        .brand { display: flex; align-items: center; gap: 12px; }
        .logo { width: auto; max-height: 48px; border-radius: 8px; object-fit: contain; }
        .main-nav { display: flex; align-items: center; gap: 4px; margin-left: 16px; }
        .main-nav a { display: flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 8px; color: var(--text-muted); font-weight: 500; font-size: 14px; transition: all 0.2s ease; text-decoration: none; }
        .main-nav a:hover, .main-nav a.active { background: var(--bg-soft); color: var(--text); }
        .main-nav a.active i { color: var(--accent); }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .icon-btn { width: 44px; height: 44px; border-radius: 10px; display: inline-flex; align-items: center; justify-content: center; color: var(--text-muted); border: 1px solid transparent; cursor: pointer; transition: all 0.2s ease; position: relative; }
        .icon-btn:hover { background: var(--bg-soft); color: var(--text); border-color: var(--border); }
        a.icon-btn { color: var(--text-muted); }
        a.icon-btn:hover { color: var(--accent); }
        .user-display { display: flex; align-items: center; gap: 10px; cursor: pointer; position: relative; }
        .user-display img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border); }
        .mobile-menu-btn { display: none; }
        .mobile-menu-dropdown { display: none; position: absolute; right: 0; top: 60px; background: var(--bg); border: 1px solid var(--border); border-radius: 10px; padding: 8px; box-shadow: var(--shadow); z-index: 1300; width: 200px; }
        .mobile-menu-dropdown a { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: 8px; color: var(--text-muted); font-size: 14px; font-weight: 500; text-decoration: none; }
        .mobile-menu-dropdown a:hover { background-color: var(--bg-soft); color: var(--text); }

        /* --- Main Chat Layout --- */
        #chat-container { max-width: 900px; margin: 24px auto; background: var(--bg); border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--shadow); overflow: hidden; display: flex; flex-direction: column; height: calc(100vh - var(--header-height) - 48px); }
        #chat-box { flex-grow: 1; padding: 24px; overflow-y: auto; display: flex; flex-direction: column; gap: 18px; }
        .message-container { display: flex; flex-direction: column; align-items: flex-start; animation: fadeInScale 0.3s ease-out; }
        .user-message-container { align-items: flex-end; }
        .message { max-width: 80%; padding: 12px 18px; border-radius: var(--radius); font-size: 15px; line-height: 1.6; position: relative; }
        .user-message { background: var(--user-message-bg); color: var(--user-message-text); border-bottom-right-radius: 4px; }
        .ai-message { background: var(--ai-message-bg); color: var(--text); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
        
        /* --- Typing Indicator --- */
        .typing-indicator { display: flex; align-items: center; gap: 6px; padding: 12px 18px; background: var(--ai-message-bg); border-radius: var(--radius); border: 1px solid var(--border); width: fit-content; }
        .typing-dot { width: 7px; height: 7px; background: var(--typing-dot-color); border-radius: 50%; animation: bounce 1.2s infinite ease-in-out; }
        .typing-dot:nth-child(2) { animation-delay: 0.15s; }
        .typing-dot:nth-child(3) { animation-delay: 0.3s; }

        /* --- Input Area --- */
        .input-container { background: var(--bg); padding: 12px 24px; border-top: 1px solid var(--border); }
        .input-box { display: flex; align-items: flex-end; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius); padding: 8px; transition: all 0.2s ease; }
        .input-box:focus-within { border-color: var(--input-border-focus); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15); }
        #user-input { flex: 1; border: none; outline: none; padding: 6px; font-size: 15px; line-height: 1.5; resize: none; max-height: 120px; background: transparent; color: var(--text); }
        #send-button { background: var(--accent); color: #fff; border: none; width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.2s ease, transform 0.2s ease; margin-left: 8px; flex-shrink: 0; }
        #send-button:hover { background: #2563EB; }
        #send-button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .input-action-button { background: none; border: none; color: var(--text-muted); width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.2s ease, color 0.2s ease; font-size: 1em; flex-shrink: 0; }
        .input-action-button:hover { background: var(--bg-soft); color: var(--text); }
        .input-actions { position: relative; }
        #voice-button.listening { color: #ef4444; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* --- Dropdowns --- */
        .plus-dropdown { position: absolute; bottom: 55px; left: 0; background: var(--bg); border-radius: 10px; box-shadow: var(--shadow); list-style: none; padding: 8px; min-width: 240px; opacity: 0; visibility: hidden; transform: translateY(10px); transition: all 0.2s ease; z-index: 1001; border: 1px solid var(--border); }
        .plus-dropdown.active { opacity: 1; visibility: visible; transform: translateY(0); }
        .plus-dropdown li { padding: 10px 15px; cursor: pointer; color: var(--text-muted); font-size: 14px; display: flex; align-items: center; gap: 10px; transition: all 0.2s ease; border-radius: 8px; }
        .plus-dropdown li:hover { background: var(--bg-soft); color: var(--text); }
        .plus-dropdown li.selected { background: var(--bg-soft); font-weight: 600; color: var(--text); }
        .dropdown-divider { height: 1px; background-color: var(--border); margin: 8px 0; }
        .dropdown-header { font-size: 12px; color: var(--text-muted); padding: 8px 15px 4px; font-weight: 600; text-transform: uppercase; }

        /* --- Advanced Markdown & Formatted Content --- */
        .ai-message * { margin: 0; padding: 0; }
        .ai-message p, .ai-message ul, .ai-message ol, .ai-message blockquote, .ai-message table { margin-bottom: 12px; }
        .ai-message ul, .ai-message ol { padding-left: 20px; }
        .ai-message li { margin-bottom: 4px; }
        .ai-message a { color: var(--accent); text-decoration: none; }
        .ai-message a:hover { text-decoration: underline; }
        .ai-message strong { color: var(--text); font-weight: 600; }
        .ai-message em { font-style: italic; }
        .ai-message blockquote { border-left: 3px solid var(--accent); padding-left: 15px; color: var(--text-muted); font-style: italic; margin-left: 5px; }
        .ai-message code { background-color: rgba(0,0,0,0.05); padding: 2px 5px; border-radius: 4px; font-family: 'Courier New', Courier, monospace; font-size: 0.9em; }
        .ai-message pre { background-color: #eef2f9; color: #334155; padding: 16px; border-radius: 8px; margin: 12px 0; font-family: 'Courier New', Courier, monospace; font-size: 14px; white-space: pre-wrap; position: relative; }
        .ai-message pre code { background: transparent; padding: 0; }
        .copy-code-btn { position: absolute; top: 8px; right: 8px; background: #d1d5db; color: #4b5563; border: none; padding: 4px 8px; border-radius: 6px; cursor: pointer; font-size: 12px; opacity: 0.8; transition: all 0.2s ease; }
        .copy-code-btn:hover { background: #9ca3af; color: #1f2937; }
        .copy-code-btn .fa-check { color: #22c55e; }
        .ai-message table { border-collapse: collapse; width: 100%; border: 1px solid var(--border); }
        .ai-message th, .ai-message td { border: 1px solid var(--border); padding: 8px 12px; text-align: left; }
        .ai-message th { background-color: var(--bg-soft); }

        /* --- Quick Actions & Suggestions --- */
        .quick-actions { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
        .quick-action-btn { background-color: var(--bg); border: 1px solid var(--border); color: var(--text-muted); padding: 6px 12px; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s ease; }
        .quick-action-btn:hover { background-color: var(--bg-soft); color: var(--accent); border-color: var(--accent); }
        #suggested-prompts { display: flex; flex-wrap: wrap; gap: 8px; padding: 12px 24px 0 24px; }
        .prompt-chip { background-color: var(--bg-soft); border: 1px solid var(--border); color: var(--text); padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 13px; transition: all 0.2s ease; }
        .prompt-chip:hover { background-color: #eef2f9; border-color: #dbeafe; }

        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }

        /* --- Responsive Styles --- */
        @media (max-width: 820px) {
            .main-nav a[href="./chatai.html"], .main-nav a[href="./roomchat.html"], .main-nav a[href="./index.html#pricing"] { display: none; }
            .main-nav span { display: none; } .main-nav a { padding: 8px; gap: 0; }
            .site-title { display: none; } .main-nav { margin-left: 8px; gap: 8px; }
            .header-right { gap: 8px; } header.app-header { padding: 0 16px; }
            .mobile-menu-btn { display: inline-flex; }
            #chat-container { height: calc(100vh - var(--header-height)); margin: 0; border-radius: 0; border-left: 0; border-right: 0; }
            #chat-box { padding: 16px; } .input-container { padding: 8px 12px; }
            #suggested-prompts { padding: 8px 12px 0 12px; }
        }
    </style>
</head>
<body>

    <header class="app-header">
        <div style="display:flex;align-items:center;">
          <div class="brand">
            <img src="fde8b58d-513b-45b3-9a8b-8a81e7535bec.jpg" alt="WordWhizzy Logo" class="logo">
          </div>
          <nav class="main-nav" aria-label="Chính">
            <a href="./index.html" title="Trang chủ"><i class="fa-solid fa-house"></i> <span>Trang chủ</span></a>
            <a href="./tuhoc.html" title="Thư viện"><i class="fa-solid fa-book-open"></i> <span>Thư viện</span></a>
            <a href="./main/vocabulary.html" title="Tạo Flashcard"><i class="fa-solid fa-layer-group"></i> <span>Flashcard</span></a>
            <a href="./chatai.html" title="Chat AI" class="active"><i class="fa-solid fa-comments"></i> <span>Chat AI</span></a>
            <a href="./roomchat.html" title="Room Chat"><i class="fa-solid fa-users"></i> <span>Room Chat</span></a>
            <a href="./index.html#pricing" title="Gói học"><i class="fa-solid fa-gem"></i> <span>Gói học</span></a>
          </nav>
        </div>
    
        <div class="header-right">
          <a href="thongbao.html" class="icon-btn" id="btn-noti" title="Thông báo"><i class="fa-regular fa-bell"></i></a>
          <div class="icon-btn" id="btn-help" title="Trợ giúp"><i class="fa-regular fa-circle-question"></i></div>
          
          <div class="icon-btn mobile-menu-btn" id="mobileMenuBtn">
            <i class="fa-solid fa-ellipsis-vertical"></i>
            <div class="mobile-menu-dropdown" id="mobileMenuDropdown">
              <a href="./chatai.html" title="Chat AI"><i class="fa-solid fa-comments"></i> <span>Chat AI</span></a>
              <a href="./roomchat.html" title="Room Chat"><i class="fa-solid fa-users"></i> <span>Room Chat</span></a>
              <a href="./index.html#pricing" title="Gói học"><i class="fa-solid fa-gem"></i> <span>Gói học</span></a>
            </div>
          </div>
    
          <div class="user-display" id="headerControls"></div>
        </div>
    </header>

    <main>
        <div id="chat-container">
            <div id="chat-box"></div>
            <div id="suggested-prompts"></div>
            <div class="input-container">
                <div class="input-box">
                    <div class="input-actions">
                         <button id="plus-button" class="input-action-button" title="Tùy chọn khác"><i class="fas fa-plus"></i></button>
                        <ul class="plus-dropdown" id="model-options-dropdown">
                            <li class="dropdown-header">Mô hình AI</li>
                            <li data-model="gpt-4" class="selected"><i class="fas fa-microchip"></i> Unier i-1.1</li>
                             <li data-model="gpt-3.5-turbo"><i class="fas fa-brain"></i> Unier i-1.0</li>
                            <div class="dropdown-divider"></div>
                            <li id="new-chat-button"><i class="fas fa-comment-medical"></i> Cuộc trò chuyện mới</li>
                             <div class="dropdown-divider"></div>
                             <li class="dropdown-header">Chế độ Hội thoại</li>
                             <li class="role-play-option" data-scenario="coffee-shop"><i class="fas fa-coffee"></i> Tại quán cà phê</li>
                             <li class="role-play-option" data-scenario="job-interview"><i class="fas fa-user-tie"></i> Phỏng vấn xin việc</li>
                        </ul>
                    </div>
                    <button id="voice-button" class="input-action-button" title="Nhập bằng giọng nói"><i class="fas fa-microphone"></i></button>
                    <textarea id="user-input" placeholder="Hỏi AI bất cứ điều gì..." rows="1"></textarea>
                     <button id="send-button">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M22 2L11 13M22 2L15 22L11 13M11 13L2 9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                    </button>
                </div>
            </div>
           </div>
    </main>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script type="module">
        // --- Firebase & Auth ---
        // FIX: Restored full firebaseConfig from your original code
        const firebaseConfig = {
            apiKey: "AIzaSyAm-p5xIzMi7Rkt6y9TzODJLFjdpLKBIlg",
            authDomain: "wordwhizzy.firebaseapp.com",
            projectId: "wordwhizzy",
            storageBucket: "wordwhizzy.appspot.com",
            messagingSenderId: "179575783469",
            appId: "1:179575783469:web:30d0ae652af3cfda4bb8a4",
        };

        // This line caused the error. Now it will work because firebaseConfig is correct
        // and the scripts are loaded before this module runs.
        if (!firebase.apps.length) { 
            firebase.initializeApp(firebaseConfig); 
        } 
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentFirebaseUser = null;
        
        async function getUserProfile(uid) {
            const docRef = db.collection("users").doc(uid);
            const docSnap = await docRef.get();
            return docSnap.exists ? docSnap.data() : null;
        }

        // FIX: Restored full auth logic
        auth.onAuthStateChanged(async (user) => {
            currentFirebaseUser = user;
            const headerControls = document.getElementById("headerControls");
            if (user) {
                headerControls.innerHTML = "";
                let userProfile = await getUserProfile(user.uid);
                
                let photoURL = userProfile?.avatarURL || user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName || 'U'}&background=random`;
                
                const userDisplay = document.createElement("div");
                userDisplay.className = "user-display";
                userDisplay.innerHTML = `<img src="${photoURL}" alt="Avatar"><div id="userDropdown" style="display:none;position:absolute;right:0;top:60px;background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:8px;box-shadow:var(--shadow);z-index:1300;width:200px;"></div>`;
                headerControls.appendChild(userDisplay);
                
                const userDropdown = document.getElementById('userDropdown');
                userDropdown.innerHTML = `
                    <div style="padding: 8px 12px; border-bottom: 1px solid var(--border); margin-bottom: 8px;">
                        <div style="font-weight:600; font-size:14px;">${user.displayName || 'Người dùng'}</div>
                    </div>
                    <a href="#" id="settingsBtn" style="display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;color:var(--text-muted);font-size:14px;text-decoration:none;"><i class="fa-solid fa-gear"></i>Cài đặt</a>
                    <a href="#" id="logoutBtn" style="display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;color:var(--text-muted);font-size:14px;text-decoration:none;"><i class="fa-solid fa-arrow-right-from-bracket"></i>Đăng xuất</a>`;
                
                userDisplay.addEventListener('click', (e) => {
                    e.stopPropagation();
                    userDropdown.style.display = userDropdown.style.display === 'block' ? 'none' : 'block';
                });
                document.getElementById('logoutBtn').addEventListener('click', e => { e.preventDefault(); auth.signOut(); });

            } else { 
                window.location.href = 'login.html'; 
            }
        });

        // --- All new Chat Logic from previous response ---
        // (This part remains the same as it contains the new features)
        const WORKER_URL = "https://api-alpha-six-99.vercel.app/api/chat";
        const chatBox = document.getElementById("chat-box");
        const userInput = document.getElementById("user-input");
        const sendButton = document.getElementById("send-button");
        const plusButton = document.getElementById("plus-button");
        const modelOptionsDropdown = document.getElementById("model-options-dropdown");
        const suggestedPromptsContainer = document.getElementById("suggested-prompts");
        const voiceButton = document.getElementById("voice-button");
        const newChatButton = document.getElementById("new-chat-button");

        let selectedModel = "gpt-4";
        
        const systemPrompt = { 
            role: "system", 
            content: `Bạn là UNIer, một gia sư tiếng Anh chuyên nghiệp, sử dụng phương pháp sư phạm hiện đại. Vai trò của bạn là hướng dẫn người dùng một cách sâu sắc và có cấu trúc. Luôn luôn tuân thủ nghiêm ngặt các quy tắc sau:

**QUY TẮC BẮT BUỘC:**
1.  **Sử Dụng Markdown Toàn Diện:** Hãy tận dụng Markdown để trình bày câu trả lời một cách khoa học nhất. Dùng \`###\` cho tiêu đề, \`**\` để in đậm, \`*\` để in nghiêng, \`> \` cho trích dẫn, và bảng biểu khi so sánh.
2.  **Chủ Động Áp Dụng Khung Sườn Chuyên Gia:** Dựa vào câu hỏi của người dùng, tự động chọn và tuân thủ một trong các khung sườn giải thích sau đây:

    * **KHUNG SƯỜN GIẢI THÍCH TỪ VỰNG:**
        1.  \`### Từ: [Word]\`
        2.  \`**Phiên âm (IPA):**\` /[...]/
        3.  \`**Loại từ:**\` [e.g., Noun, Verb, Adjective]
        4.  \`**Định nghĩa:**\` [Định nghĩa rõ ràng]
        5.  \`**Ví dụ:**\`
            * [Câu ví dụ 1, **in đậm** từ đang học]
            * [Câu ví dụ 2, **in đậm** từ đang học]
        6.  \`**Từ đồng nghĩa (Synonyms):**\` [List synonyms]
        7.  \`**Từ trái nghĩa (Antonyms):**\` [List antonyms]
        8.  \`**Cụm từ phổ biến (Collocations):**\` [e.g., highly recommend, make a decision]

    * **KHUNG SƯỜN GIẢI THÍCH NGỮ PHÁP:**
        1.  \`### Ngữ pháp: [Grammar Point]\`
        2.  \`**Quy tắc:**\` [Giải thích quy tắc một cách đơn giản]
        3.  \`**Công thức:**\` 
            * Khẳng định: S + V + ...
            * Phủ định: S + aux + not + V + ...
            * Nghi vấn: Aux + S + V + ...?
        4.  \`**Ví dụ:**\` [Cung cấp ví dụ cho cả 3 dạng]
        5.  \`**Lỗi sai thường gặp:**\` [Chỉ ra lỗi sai phổ biến và giải thích tại sao sai]
        6.  \`**Khi nào dùng:**\` [Nêu rõ các ngữ cảnh, tình huống sử dụng]

    * **KHUNG Sườn SỬA LỖI:**
        1.  [Khen ngợi nỗ lực của người dùng: "Câu của bạn ý tưởng rất tốt!"]
        2.  \`**Câu gốc:**\` [Câu sai của người dùng]
        3.  \`**Câu đề xuất:**\` [Viết lại câu đúng, **in đậm** phần đã sửa]
        4.  \`**Giải thích:**\` [Chỉ ra lỗi sai (ví dụ: "lỗi chia thì," "dùng sai giới từ") và giải thích ngắn gọn quy tắc đúng.]

3.  **Duy Trì Tương Tác:** Luôn kết thúc câu trả lời bằng một câu hỏi mở để khuyến khích người dùng thực hành hoặc đào sâu kiến thức. ("Bạn có muốn thử đặt một câu với thì này không?").
4.  **Chế Độ Hội Thoại (Role-play):** Khi người dùng bắt đầu bằng "Bắt đầu kịch bản hội thoại:", hãy nhập vai nhân vật được yêu cầu một cách tự nhiên và dẫn dắt cuộc hội thoại.
`};

        let conversationHistory = [systemPrompt];
        const CHAT_HISTORY_KEY = 'wordwhizzy_chatHistory_v2';

        function saveConversation() { localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(conversationHistory)); }

        function loadConversation() {
            const savedHistory = localStorage.getItem(CHAT_HISTORY_KEY);
            if (savedHistory) {
                conversationHistory = JSON.parse(savedHistory);
                chatBox.innerHTML = "";
                conversationHistory.slice(1).forEach(msg => { appendMessage(msg.content, msg.role === 'user', false); });
                if (conversationHistory.length <= 1) { renderSuggestedPrompts(); } 
                else { suggestedPromptsContainer.style.display = 'none'; }
            } else {
                initializeChat();
            }
        }

        function initializeChat() {
            conversationHistory = [systemPrompt];
            chatBox.innerHTML = ""; 
            appendMessage(`**Chào mừng đến với UNIer!** Mình là trợ lý học tiếng Anh đã được nâng cấp. Bạn muốn bắt đầu với chủ đề nào hôm nay?`, false, true);
            renderSuggestedPrompts();
            saveConversation();
        }
        
        const promptSuggestions = [
            "Giải thích từ 'ubiquitous' theo khung sườn từ vựng.",
            "Sự khác biệt giữa 'will' và 'be going to' là gì?",
            "Sửa lỗi câu này: 'He don't have no money.'",
            "Phân tích thì quá khứ hoàn thành tiếp diễn.",
            "Cho tôi 5 từ vựng về chủ đề 'môi trường' và đặt câu với chúng.",
            "Khi nào dùng 'in', 'on', 'at' cho thời gian?",
            "So sánh 'affect' và 'effect' bằng bảng.",
            "Giải thích cấu trúc câu điều kiện loại 2."
        ];

        function getRandomPrompts(arr, num) {
            const shuffled = [...arr].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, num);
        }

        function renderSuggestedPrompts() {
            const randomPrompts = getRandomPrompts(promptSuggestions, 4);
            suggestedPromptsContainer.innerHTML = randomPrompts.map(p => `<button class="prompt-chip">${p}</button>`).join('');
            suggestedPromptsContainer.style.display = 'flex';
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US'; 
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                userInput.value = transcript;
                setTimeout(() => sendMessage(transcript), 200);
            };
            recognition.onspeechend = () => { recognition.stop(); };
            recognition.onstart = () => { voiceButton.classList.add('listening'); };
            recognition.onend = () => { voiceButton.classList.remove('listening'); };
            recognition.onerror = (event) => { console.error(`Speech recognition error: ${event.error}`); voiceButton.classList.remove('listening');};
        } else {
            voiceButton.style.display = 'none';
        }

        voiceButton.addEventListener('click', () => {
            if (recognition) {
                if (voiceButton.classList.contains('listening')) {
                    recognition.stop();
                } else {
                    try { recognition.start(); } catch(e) { console.error("Could not start recognition: ", e); }
                }
            }
        });
        
        async function sendMessage(messageContent) {
            const message = (messageContent || userInput.value).trim();
            if (!message) return;

            setInputState(false);
            suggestedPromptsContainer.style.display = 'none';
            appendMessage(message, true, true);
            conversationHistory.push({ role: "user", content: message });
            userInput.value = "";
            userInput.style.height = "auto";
            const typingIndicator = showTypingIndicator();

            try {
                const response = await getBotResponse();
                typingIndicator.remove();
                appendMessage(response, false, true);
                conversationHistory.push({ role: "assistant", content: response });
            } catch (error) {
                console.error("Error fetching bot response:", error);
                typingIndicator.remove();
                appendMessage(`> **Lỗi!**\n> Đã có sự cố xảy ra khi kết nối với AI. Vui lòng thử lại sau. \n> *Chi tiết lỗi: ${error.message}*`, false, true);
            } finally {
                setInputState(true);
                saveConversation();
            }
        }
        
        async function getBotResponse() {
             const requestBody = {
                 model: selectedModel, messages: conversationHistory,
                 temperature: 0.7, max_tokens: 2000,
                 user: currentFirebaseUser ? currentFirebaseUser.uid : 'anonymous',
            };
            const response = await fetch(WORKER_URL, {
                method: "POST", headers: { "Content-Type": "application/json" },
                body: JSON.stringify(requestBody),
            });
            if (!response.ok) throw new Error(`API error! status: ${response.status}`);
            const data = await response.json();
            return data.choices[0].message.content;
        }

        function setInputState(enabled) {
            userInput.disabled = !enabled;
            sendButton.disabled = !enabled;
            if (enabled) userInput.focus();
        }

        function showTypingIndicator() {
            const container = document.createElement("div");
            container.className = "message-container";
            container.innerHTML = `<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
            chatBox.appendChild(container);
            chatBox.scrollTop = chatBox.scrollHeight;
            return container;
        }

        function formatResponse(text) {
            const rawHTML = marked.parse(text);
            const sanitizedHTML = rawHTML.replace(/<pre>/g, '<pre><button class="copy-code-btn" onclick="copyCode(this)"><i class="far fa-copy"></i></button>');
            return sanitizedHTML;
        }

        window.copyCode = function(button) {
            const pre = button.parentElement;
            const code = pre.querySelector('code');
            navigator.clipboard.writeText(code.innerText).then(() => {
                button.innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(() => {
                    button.innerHTML = '<i class="far fa-copy"></i>';
                }, 2000);
            });
        };

        function appendMessage(content, isUser = false, animate = true) {
            const containerDiv = document.createElement("div");
            containerDiv.className = `message-container ${isUser ? 'user-message-container' : ''}`;
            if (!animate) containerDiv.style.animation = 'none';

            const messageDiv = document.createElement("div");
            messageDiv.className = `message ${isUser ? "user-message" : "ai-message"}`;
            messageDiv.innerHTML = isUser ? content.replace(/</g, "&lt;").replace(/>/g, "&gt;") : formatResponse(content);
            containerDiv.appendChild(messageDiv);

            if (!isUser && content.length > 50) { 
                const quickActionsDiv = document.createElement('div');
                quickActionsDiv.className = 'quick-actions';
                quickActionsDiv.innerHTML = `
                    <button class="quick-action-btn" data-action="example">Thêm ví dụ</button>
                    <button class="quick-action-btn" data-action="explain">Giải thích đơn giản hơn</button>
                `;
                containerDiv.appendChild(quickActionsDiv);
            }

            chatBox.appendChild(containerDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        
        // --- Event Listeners ---
        plusButton.addEventListener("click", (e) => { e.stopPropagation(); modelOptionsDropdown.classList.toggle("active"); });
        newChatButton.addEventListener("click", () => {
            if(confirm("Bạn có chắc muốn bắt đầu cuộc trò chuyện mới không? Lịch sử sẽ bị xóa.")) {
                localStorage.removeItem(CHAT_HISTORY_KEY);
                initializeChat();
                modelOptionsDropdown.classList.remove('active');
            }
        });
        
        document.addEventListener("click", (e) => {
            const userDropdown = document.getElementById('userDropdown');
            if (!e.target.closest('.user-display') && userDropdown) userDropdown.style.display = 'none';
            if (!e.target.closest('.input-actions')) modelOptionsDropdown.classList.remove('active');
            
            if (e.target.classList.contains('prompt-chip')) {
                sendMessage(e.target.innerText);
            }
            if (e.target.classList.contains('role-play-option')) {
                const scenario = e.target.dataset.scenario;
                let prompt = 'Bắt đầu kịch bản hội thoại: ';
                if(scenario === 'coffee-shop') prompt += 'Bạn là nhân viên pha chế, và tôi là khách hàng. Hãy bắt đầu chào tôi.';
                if(scenario === 'job-interview') prompt += 'Bạn là nhà tuyển dụng cho vị trí "Marketing Manager", và tôi là ứng viên. Hãy bắt đầu phỏng vấn tôi.';
                sendMessage(prompt);
                modelOptionsDropdown.classList.remove('active');
            }
            if (e.target.classList.contains('quick-action-btn')) {
                const action = e.target.dataset.action;
                const originalMessage = [...conversationHistory].reverse().find(msg => msg.role === 'assistant')?.content;
                if (!originalMessage) return;

                let prompt = '';
                if(action === 'example') prompt = `Hãy cho tôi thêm một vài ví dụ khác liên quan đến chủ đề này: "${originalMessage}"`;
                if(action === 'explain') prompt = `Hãy giải thích lại nội dung sau một cách đơn giản và dễ hiểu hơn cho người mới bắt đầu: "${originalMessage}"`;
                sendMessage(prompt);
            }
        });

        userInput.addEventListener("input", function() { this.style.height = "auto"; this.style.height = Math.min(this.scrollHeight, 120) + "px"; });
        userInput.addEventListener("keypress", (e) => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
        sendButton.addEventListener("click", () => sendMessage());

        document.addEventListener("DOMContentLoaded", () => {
             auth.onAuthStateChanged(user => { if (user) loadConversation(); });
        });
    </script>
</body>
</html>